{"version":3,"file":"for.js","sources":["compiler/directives/for.js"],"sourcesContent":["\"use strict\";\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.iteratorVFor = exports.parseVFor = exports.hasVFor = void 0;\r\nvar uuid_1 = __importDefault(require(\"../../shared/uuid\"));\r\nvar util_1 = require(\"./util\");\r\nvar regexp_1 = require(\"../../shared/regexp\");\r\nvar constants_1 = require(\"../../shared/constants\");\r\nvar util_2 = require(\"../../shared/util\");\r\nvar proxy_1 = require(\"../../core/proxy\");\r\nvar ITERATOR_CHAIN = [\r\n    {\r\n        condition: function (obj) { return util_2.isObject(obj); },\r\n        handler: iteratorObj,\r\n    },\r\n    {\r\n        condition: function (obj) { return util_2.isArray(obj); },\r\n        handler: iteratorArray,\r\n    },\r\n    {\r\n        condition: function (val) { return util_2.isNumber(val); },\r\n        handler: iteratorNumber,\r\n    },\r\n];\r\n/**\r\n * <div ref=\"aaa\">\r\n *   <my-component ref=\"bbb\"></my-component>\r\n * </div>\r\n */\r\n/**\r\n * iteratorObj - 迭代对象\r\n * @param val - Object\r\n * @param context - Object\r\n * @param el - HtmlElement\r\n * @param parentVNode - VNode\r\n * @param itItemStr - string\r\n * @param renderFun - Function\r\n * @param VNodes\r\n * @return VNodes\r\n */\r\nfunction iteratorObj(_a) {\r\n    var val = _a.val, context = _a.context, el = _a.el, parentVNode = _a.parentVNode, itItemStr = _a.itItemStr, renderFun = _a.renderFun, VNodes = _a.VNodes;\r\n    var index = 0;\r\n    for (var p in val) {\r\n        if (proxy_1.isProxyProperty(p)) {\r\n            // iteratorVFor会创建一个VNode或VNodes\r\n            var itemVNodes = iteratorVFor.call(this, {\r\n                context: proxy_1.createContext(context),\r\n                el: el,\r\n                parentVNode: parentVNode,\r\n                itItemStr: itItemStr,\r\n                itItemObj: val[p],\r\n                renderFun: renderFun,\r\n            }, \r\n            // 如果是迭代对象则是属性名\r\n            p, \r\n            // 索引值\r\n            index);\r\n            if (util_2.isArray(itemVNodes)) {\r\n                VNodes = VNodes.concat(itemVNodes);\r\n            }\r\n            else if (util_2.isObject(itemVNodes)) {\r\n                VNodes.push(itemVNodes);\r\n            }\r\n            index++;\r\n        }\r\n    }\r\n    return VNodes;\r\n}\r\n/**\r\n * iteratorArray - 迭代数组\r\n * @param val - Array\r\n * @param context - Object\r\n * @param el - HtmlElement\r\n * @param parentVNode - VNode\r\n * @param itItemStr - string\r\n * @param renderFun - Function\r\n * @param VNodes\r\n * @return VNodes\r\n */\r\nfunction iteratorArray(_a) {\r\n    var val = _a.val, context = _a.context, el = _a.el, parentVNode = _a.parentVNode, itItemStr = _a.itItemStr, renderFun = _a.renderFun, VNodes = _a.VNodes;\r\n    for (var i = 0; i < val.length; i++) {\r\n        var itemVNodes = iteratorVFor.call(this, {\r\n            context: proxy_1.createContext(context),\r\n            el: el,\r\n            parentVNode: parentVNode,\r\n            itItemStr: itItemStr,\r\n            itItemObj: val[i],\r\n            renderFun: renderFun,\r\n        }, null, \r\n        // 如果是迭代数组则是索引值\r\n        i);\r\n        if (util_2.isArray(itemVNodes)) {\r\n            VNodes = VNodes.concat(itemVNodes);\r\n        }\r\n        else if (util_2.isObject(itemVNodes)) {\r\n            VNodes.push(itemVNodes);\r\n        }\r\n    }\r\n    return VNodes;\r\n}\r\n/**\r\n * iteratorNumber - 迭代范围值\r\n * @param - val - number\r\n * @param context - Object\r\n * @param el - HtmlElement\r\n * @param parentVNode - VNode\r\n * @param itItemStr - string\r\n * @param renderFun - Function\r\n * @param VNodes\r\n * @return VNodes\r\n */\r\nfunction iteratorNumber(_a) {\r\n    var val = _a.val, context = _a.context, el = _a.el, parentVNode = _a.parentVNode, itItemStr = _a.itItemStr, renderFun = _a.renderFun, VNodes = _a.VNodes;\r\n    for (var i = 1; i <= val; i++) {\r\n        var itemVNodes = iteratorVFor.call(this, {\r\n            context: proxy_1.createContext(context),\r\n            el: el,\r\n            parentVNode: parentVNode,\r\n            itItemStr: itItemStr,\r\n            itItemObj: i,\r\n            renderFun: renderFun,\r\n        }, \r\n        // 如果是迭代对象则是属性名\r\n        null, \r\n        // 索引值\r\n        i);\r\n        if (util_2.isArray(itemVNodes)) {\r\n            VNodes = VNodes.concat(itemVNodes);\r\n        }\r\n        else if (util_2.isObject(itemVNodes)) {\r\n            VNodes.push(itemVNodes);\r\n        }\r\n    }\r\n    return VNodes;\r\n}\r\n/**\r\n * hasVFor - 是否有v-for属性\r\n * @param attrNames - Array 所有的指令属性集合\r\n * @return {boolean}\r\n */\r\nfunction hasVFor(attrNames) {\r\n    return util_1.hasVAttr(attrNames, constants_1.DIRECT_PREFIX + \"for\");\r\n}\r\nexports.hasVFor = hasVFor;\r\n/**\r\n * parseVFor - 解析v-for\r\n * @param context - Object 上下文对象\r\n * @param el - HtmlElement 当前元素\r\n * @param parentVNode - VNode 父VNode节点\r\n * @param vAttrNames - Array 指令属性集合\r\n * @param renderFun - Function render函数\r\n * @return {Array<VNode>}\r\n */\r\nfunction parseVFor(_a) {\r\n    var context = _a.context, el = _a.el, parentVNode = _a.parentVNode, vAttrNames = _a.vAttrNames, renderFun = _a.renderFun;\r\n    // 如果没有group属性则创建一个\r\n    // group属性使用来给v-for进行分组的\r\n    var groupName = el.getAttribute(constants_1.GROUP_KEY_NAME);\r\n    if (!el.hasAttribute(constants_1.GROUP_KEY_NAME) || !groupName) {\r\n        groupName = uuid_1.default();\r\n        el.setAttribute(constants_1.GROUP_KEY_NAME, groupName);\r\n    }\r\n    var attrName = vAttrNames.find(function (n) { return n.indexOf(constants_1.DIRECT_PREFIX + \"for\") !== -1; });\r\n    //  <li v-for=\"item in items\"></li>\r\n    //  <li v-for=\"(item,index) in items\">\r\n    //    <div>{{item,index}}</div>\r\n    //  </li>\r\n    // (item,index) in items\r\n    // item in items\r\n    // (item) in items\r\n    // v-for=\"\"的值\r\n    var value = el.getAttribute(attrName);\r\n    // 把值进行分割获取表达式的部分\r\n    var grammar = value.split(regexp_1.EMPTY_SPLIT);\r\n    if (grammar.length !== 2)\r\n        return null;\r\n    // item 获取 (item,index)\r\n    var itItemStr = grammar[0].trim();\r\n    // data中的值\r\n    var itObjStr = grammar[1].trim();\r\n    var VNodes = [];\r\n    // 获取迭代的对象，分为对象迭代和数组迭代\r\n    var itObj = util_2.execExpression.call(this, context, itObjStr); // eval(`with(context){${itObjStr}}`); /* context[itObjStr] */\r\n    var index = 0;\r\n    while (index < ITERATOR_CHAIN.length) {\r\n        if (ITERATOR_CHAIN[index].condition(itObj)) {\r\n            VNodes = ITERATOR_CHAIN[index].handler.call(this, {\r\n                val: itObj,\r\n                context: context,\r\n                el: el,\r\n                parentVNode: parentVNode,\r\n                itItemStr: itItemStr,\r\n                renderFun: renderFun,\r\n                VNodes: VNodes,\r\n            });\r\n            break;\r\n        }\r\n        index++;\r\n    }\r\n    // 比较删除componentsMap中没有的组件引用\r\n    var componentKeys = this.componentsMap.keys();\r\n    var _loop_1 = function () {\r\n        var currentKey = componentKeys.pop();\r\n        // componentKeys和VNode之间的插集\r\n        var has = VNodes.some(function (VNode) { return VNode.key === currentKey; });\r\n        if (!has) {\r\n            this_1.componentsMap.delete(currentKey);\r\n        }\r\n    };\r\n    var this_1 = this;\r\n    // 迭代进行删除\r\n    while (componentKeys.length) {\r\n        _loop_1();\r\n    }\r\n    return VNodes;\r\n}\r\nexports.parseVFor = parseVFor;\r\n/**\r\n * iteratorVFor - 对v-for进行迭代(一个的生成)\r\n * @param context - Object 上下文对象\r\n * @param el - HtmlElement\r\n * @param parentVNode - VNode 父VNode\r\n * @param itItemStr - Object 迭代项变量\r\n * @param itItemObj - Object | Array 迭代的变量\r\n * @param renderFun - Function 渲染函数\r\n * @param property - string 属性名\r\n * @param index - number v-for的索引\r\n * @return {VNode | Array<VNode>}\r\n */\r\nfunction iteratorVFor(_a, property, index) {\r\n    var context = _a.context, el = _a.el, parentVNode = _a.parentVNode, itItemStr = _a.itItemStr, itItemObj = _a.itItemObj, renderFun = _a.renderFun;\r\n    // 如果项的迭代对象是用()进行包裹的\r\n    if (itItemStr.startsWith('(') && itItemStr.endsWith(')')) {\r\n        // item   ,    index\r\n        // 截取出()中的值\r\n        itItemStr = itItemStr.substring(1, itItemStr.length - 1).trim();\r\n        // 如果内容中包含','\r\n        if (itItemStr.indexOf(',') !== -1) {\r\n            var itItemArr = itItemStr.split(',').map(function (t) { return t.trim(); });\r\n            // 从context中获取迭代项数据\r\n            context[itItemArr[0].trim()] = itItemObj;\r\n            // 如果是迭代对象则是属性名，否则是索引\r\n            context[itItemArr[1].trim()] = property || index;\r\n            // 是索引\r\n            if (itItemArr.length >= 3) {\r\n                context[itItemArr[2].trim()] = index;\r\n            }\r\n        }\r\n        else {\r\n            // 从context中获取迭代项数据\r\n            context[itItemStr] = itItemObj;\r\n        }\r\n    }\r\n    else {\r\n        // 从context中获取迭代项数据\r\n        context[itItemStr] = itItemObj;\r\n    }\r\n    // 所有属性的集合\r\n    var attrNames = el.getAttributeNames();\r\n    // 处理cloneEl的key 需要加入group的值\r\n    var groupName = el.getAttribute(constants_1.GROUP_KEY_NAME);\r\n    // 元素有key属性\r\n    // 如果元素有key属性则需要对key属性进行一个全局唯一标识的处理\r\n    // 处理的方式就是给key加上groupName的前缀\r\n    // if (attrNames.indexOf(`${DIRECT_PREFIX}bind:key`) !== -1) {\r\n    //   const key = `${DIRECT_PREFIX}bind:key`;\r\n    //   const value = el.getAttribute(key);\r\n    //   const expressVal = execExpression.call(this, context, value);\r\n    //   if (!this.componentsMap.has(expressVal)) {\r\n    //     // 给key加入groupName前缀使之全局唯一\r\n    //     el.setAttribute(key, `'${groupName}' + '(${expressVal})'`);\r\n    //   }\r\n    // } else if (attrNames.indexOf('key')) {\r\n    //   const key = 'key';\r\n    //   const value = el.getAttribute(key);\r\n    //   if (!this.componentsMap.has(value)) {\r\n    //     // 给key加入groupName前缀使之全局唯一\r\n    //     el.setAttribute(key, `${groupName}(${value})`);\r\n    //   }\r\n    // } else {\r\n    //   // 如果v-for没写key则用索引作为key\r\n    //   el.setAttribute('key', `${groupName}${index}`);\r\n    // }\r\n    // 对v-for元素进行克隆,克隆之后cloneEl会有groupName属性\r\n    var cloneEl = el.cloneNode(true);\r\n    if (attrNames.indexOf(constants_1.DIRECT_PREFIX + \"bind:key\") !== -1) {\r\n        var key = constants_1.DIRECT_PREFIX + \"bind:key\";\r\n        var value = cloneEl.getAttribute(key);\r\n        var expressVal = util_2.execExpression.call(this, context, value);\r\n        cloneEl.setAttribute(key, \"'\" + groupName + \"' + '(\" + expressVal + \")'\");\r\n    }\r\n    else if (attrNames.indexOf('key')) {\r\n        var key = 'key';\r\n        var value = cloneEl.getAttribute(key);\r\n        cloneEl.setAttribute(key, groupName + \"(\" + value + \")\");\r\n    }\r\n    else {\r\n        cloneEl.setAttribute('key', \"\" + groupName + index);\r\n    }\r\n    // 删除v-for属性\r\n    cloneEl.removeAttribute(constants_1.DIRECT_PREFIX + \"for\");\r\n    return renderFun.call(this, {\r\n        context: context,\r\n        el: cloneEl,\r\n        parentVNode: parentVNode,\r\n        parentElement: el.parentElement,\r\n    });\r\n}\r\nexports.iteratorVFor = iteratorVFor;\r\n"],"names":["__importDefault","this","mod","__esModule","default","Object","defineProperty","exports","value","iteratorVFor","parseVFor","hasVFor","uuid_1","require","util_1","regexp_1","constants_1","util_2","proxy_1","ITERATOR_CHAIN","condition","obj","isObject","handler","iteratorObj","isArray","iteratorArray","val","isNumber","iteratorNumber","_a","p","itemVNodes","context","el","parentVNode","itItemStr","renderFun","VNodes","index","isProxyProperty","call","createContext","itItemObj","concat","push","i","length","attrNames","hasVAttr","DIRECT_PREFIX","vAttrNames","groupName","getAttribute","GROUP_KEY_NAME","hasAttribute","setAttribute","attrName","find","n","indexOf","grammar","split","EMPTY_SPLIT","trim","itObjStr","itObj","execExpression","componentKeys","componentsMap","keys","this_1","currentKey","pop","some","VNode","key","delete","_loop_1","property","startsWith","endsWith","substring","itItemArr","map","t","getAttributeNames","cloneEl","cloneNode","expressVal","removeAttribute","parentElement"],"mappings":"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"}