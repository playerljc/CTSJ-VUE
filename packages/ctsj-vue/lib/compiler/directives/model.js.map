{"version":3,"file":"model.js","sources":["compiler/directives/model.js"],"sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.filterChain = exports.isFormTag = exports.parseOption = exports.parseVModel = exports.getVModelEntrys = exports.hasVModel = void 0;\r\nvar util_1 = require(\"../../shared/util\");\r\nvar util_2 = require(\"./util\");\r\nvar constants_1 = require(\"../../shared/constants\");\r\n/**\r\n * hasVModel\r\n * @param attrNames\r\n * @return {*}\r\n */\r\nfunction hasVModel(attrNames) {\r\n    return util_2.hasVAttr(attrNames, constants_1.DIRECT_PREFIX + \"model\");\r\n}\r\nexports.hasVModel = hasVModel;\r\n/**\r\n * getInputType\r\n * @param context\r\n * @param el\r\n * @return String\r\n */\r\nfunction getInputType(context, el) {\r\n    return getInputProp.call(this, { context: context, el: el, propName: 'type' }) || 'text';\r\n}\r\n/**\r\n * getInputValue\r\n * @param context\r\n * @param el\r\n * @return String\r\n */\r\nfunction getInputValue(context, el) {\r\n    return getInputProp.call(this, { context: context, el: el, propName: 'value' });\r\n}\r\n/**\r\n * getInputProp\r\n * @param context\r\n * @param el\r\n * @param propName\r\n * @return {string|*}\r\n */\r\nfunction getInputProp(_a) {\r\n    var context = _a.context, el = _a.el, propName = _a.propName;\r\n    var attrNames = el.getAttributeNames();\r\n    if (attrNames.includes(propName)) {\r\n        return el.getAttribute(propName);\r\n    }\r\n    if (attrNames.includes(constants_1.DIRECT_PREFIX + \"bind:\" + propName)) {\r\n        var value = el.getAttribute(constants_1.DIRECT_PREFIX + \"bind:\" + propName);\r\n        return util_1.execExpression.call(this, context, value);\r\n    }\r\n    return '';\r\n}\r\n/**\r\n * hasProp - 是否存在指定的属性\r\n * @param el\r\n * @param prop\r\n * @return {boolean}\r\n */\r\nfunction hasProp(_a) {\r\n    var el = _a.el, prop = _a.prop;\r\n    var attrNames = el.getAttributeNames();\r\n    var exists = attrNames.includes(prop);\r\n    if (!exists) {\r\n        exists = attrNames.includes(constants_1.DIRECT_PREFIX + \"bind:\" + prop);\r\n    }\r\n    return exists;\r\n}\r\n/**\r\n * getVModelEntrys\r\n * @param el\r\n * @param vAttrNames\r\n * @return {{expression: *, arg: string, name: string, modifiers: {}|{}, value: string}|null}\r\n */\r\nfunction getVModelEntrys(_a) {\r\n    var el = _a.el, vAttrNames = _a.vAttrNames;\r\n    var attrs = vAttrNames.filter(function (n) { return n.indexOf(constants_1.DIRECT_PREFIX + \"model\") !== -1; });\r\n    if (!attrs.length)\r\n        return null;\r\n    // 取出最后一个attr\r\n    var attrName = attrs[attrs.length - 1];\r\n    // 获取v-model=\"xxx\" 的 xxx\r\n    return util_2.getDirectiveEntry(el, attrName);\r\n}\r\nexports.getVModelEntrys = getVModelEntrys;\r\n/**\r\n * parseVModel\r\n * @param context\r\n * @param el\r\n * @param vAttrNames\r\n * @param tagName\r\n * @param VNode\r\n * @return {*}\r\n */\r\nfunction parseVModel(_a) {\r\n    var context = _a.context, el = _a.el, vAttrNames = _a.vAttrNames, tagName = _a.tagName, VNode = _a.VNode;\r\n    var self = this;\r\n    // const attrs = vAttrNames.filter((n) => n.indexOf(`${DIRECT_PREFIX}model`) !== -1);\r\n    //\r\n    // if (!attrs.length) return null;\r\n    //\r\n    // // 取出最后一个attr\r\n    // const attrName = attrs[attrs.length - 1];\r\n    // 获取v-model=\"xxx\" 的 xxx\r\n    // const entry = getDirectiveEntry(el, attrName);\r\n    var entry = getVModelEntrys({ el: el, vAttrNames: vAttrNames });\r\n    if (!entry)\r\n        return null;\r\n    // v-model的值\r\n    var value = util_1.execExpression.call(this, context, entry.expression);\r\n    var inputType = getInputType.call(this, context, el);\r\n    var inputValue = getInputValue.call(this, context, el);\r\n    // 1.赋值\r\n    if (tagName === 'input') {\r\n        // radio | checkbox\r\n        if (constants_1.FORM_CONTROL_CHECKED_TAG_NAMES.includes(inputType)) {\r\n            // value属性\r\n            if (inputValue) {\r\n                //  <input type=\"radio\" value=\"1\" v-model=\"sex\" />男\r\n                //  <input type=\"radio\" value=\"2\" v-model=\"sex\" />女\r\n                if (inputType === 'radio') {\r\n                    VNode.data.props.checked = value == inputValue;\r\n                }\r\n                // checkbox\r\n                //  <input type=\"checkbox\" value=\"1\" v-model=\"data\" />java\r\n                //  <input type=\"checkbox\" value=\"2\" v-model=\"data\" />c++\r\n                //  <input type=\"checkbox\" value=\"3\" v-model=\"data\" />javascript\r\n                else if (inputType === 'checkbox') {\r\n                    if (util_1.isArray(value)) {\r\n                        VNode.data.props.checked = value.includes(inputValue);\r\n                    }\r\n                    else {\r\n                        VNode.data.props.checked = value == inputValue;\r\n                    }\r\n                }\r\n            }\r\n            // 没有value属性\r\n            else {\r\n                VNode.data.props.checked = value;\r\n            }\r\n        }\r\n        // text | number | ...\r\n        else {\r\n            VNode.data.props.value = value;\r\n        }\r\n    }\r\n    // textarea\r\n    else if (tagName === 'textarea') {\r\n        VNode.data.props.value = value;\r\n    }\r\n    // select\r\n    // else if (tagName === 'select') {\r\n    //   //  <select>\r\n    //   //    <option>java</option>\r\n    //   //    <option>c++</option>\r\n    //   //    <option>javascript</option>\r\n    //   //  </select>\r\n    //\r\n    //   // 获取select下所有的option\r\n    //   const optionEls = Array.from(el.querySelectorAll('option'));\r\n    //   optionEls.forEach((optionEl) => {\r\n    //     // 获取option的value value表示的是text或value\r\n    //     const val = optionEl.value.trim();\r\n    //\r\n    //     // model的值是数组\r\n    //     if (isArray(value)) {\r\n    //       if (value.includes(val)) {\r\n    //         optionEl.setAttribute('selected', 'selected');\r\n    //       }\r\n    //     }\r\n    //     // model的值不是数组\r\n    //     else if (val == value) {\r\n    //       optionEl.setAttribute('selected', 'selected');\r\n    //     }\r\n    //   });\r\n    // }\r\n    var lazy = entry.modifiers.lazy;\r\n    // 2.事件\r\n    // select标签\r\n    if (tagName === 'select') {\r\n        VNode.data.on.change = function (e) {\r\n            util_1.createExecutionContext.call(self, self, function () {\r\n                var selectedOptions = e.target.selectedOptions;\r\n                // 多选的模式\r\n                if (hasProp({ el: el, prop: 'multiple' })) {\r\n                    // model的值是数组\r\n                    if (util_1.isArray(value)) {\r\n                        self.$dataProxy[entry.expression] = Array.from(selectedOptions).map(function (selectedOption) {\r\n                            return filterChain(selectedOption.value, entry);\r\n                        });\r\n                    }\r\n                    // 不是数组不处理\r\n                }\r\n                // 非多选的模式\r\n                else {\r\n                    // 不是数组才处理\r\n                    if (!util_1.isArray(value)) {\r\n                        self.$dataProxy[entry.expression] = filterChain(selectedOptions[0].value, entry);\r\n                    }\r\n                }\r\n            });\r\n        };\r\n    }\r\n    // input标签\r\n    else if (tagName === 'input') {\r\n        // radio | checkbox\r\n        if (constants_1.FORM_CONTROL_CHECKED_TAG_NAMES.includes(inputType)) {\r\n            // 有value属性\r\n            if (inputValue) {\r\n                //  <input type=\"radio\" value=\"1\" v-model=\"sex\" />男\r\n                //  <input type=\"radio\" value=\"2\" v-model=\"sex\" />女\r\n                if (inputType === 'radio') {\r\n                    VNode.data.on.change = function (e) {\r\n                        util_1.createExecutionContext.call(self, self, function () {\r\n                            self.$dataProxy[entry.expression] = e.target.checked ? inputValue : '';\r\n                        });\r\n                    };\r\n                }\r\n                //  <input type=\"checkbox\" value=\"1\" v-model=\"data\" />java\r\n                //  <input type=\"checkbox\" value=\"2\" v-model=\"data\" />c++\r\n                //  <input type=\"checkbox\" value=\"3\" v-model=\"data\" />javascript\r\n                else if (inputType === 'checkbox') {\r\n                    if (util_1.isArray(value)) {\r\n                        VNode.data.on.change = function (e) {\r\n                            util_1.createExecutionContext.call(self, self, function () {\r\n                                if (e.target.checked) {\r\n                                    self.$dataProxy[entry.expression].push(inputValue);\r\n                                }\r\n                                else {\r\n                                    var deleteIndex = self.$dataProxy[entry.expression].indexOf(inputValue);\r\n                                    if (deleteIndex !== -1) {\r\n                                        self.$dataProxy[entry.expression].splice(deleteIndex, 1);\r\n                                    }\r\n                                }\r\n                            });\r\n                        };\r\n                    }\r\n                    // 不是数组\r\n                    else {\r\n                        VNode.data.on.change = function (e) {\r\n                            util_1.createExecutionContext.call(self, self, function () {\r\n                                self.$dataProxy[entry.expression] = e.target.checked ? inputValue : '';\r\n                            });\r\n                        };\r\n                    }\r\n                }\r\n            }\r\n            // 没有value属性\r\n            else {\r\n                VNode.data.on.change = function (e) {\r\n                    util_1.createExecutionContext.call(self, self, function () {\r\n                        self.$dataProxy[entry.expression] = e.target.checked;\r\n                    });\r\n                };\r\n            }\r\n        }\r\n        // text | number ... lazy\r\n        else if (lazy) {\r\n            VNode.data.on.change = function (e) {\r\n                util_1.createExecutionContext.call(self, self, function () {\r\n                    self.$dataProxy[entry.expression] = filterChain(e.target.value, entry);\r\n                });\r\n            };\r\n        }\r\n        // text | number ... 没有lazy\r\n        else {\r\n            VNode.data.on.input = function (e) {\r\n                util_1.createExecutionContext.call(self, self, function () {\r\n                    self.$dataProxy[entry.expression] = filterChain(e.target.value, entry);\r\n                });\r\n            };\r\n        }\r\n    }\r\n    // textarea标签 lazy\r\n    else if (lazy) {\r\n        VNode.data.on.change = function (e) {\r\n            util_1.createExecutionContext.call(self, self, function () {\r\n                self.$dataProxy[entry.expression] = filterChain(e.target.value, entry);\r\n            });\r\n        };\r\n    }\r\n    // textarea标签 没有lazy\r\n    else {\r\n        VNode.data.on.input = function (e) {\r\n            util_1.createExecutionContext.call(self, self, function () {\r\n                self.$dataProxy[entry.expression] = filterChain(e.target.value, entry);\r\n            });\r\n        };\r\n    }\r\n    return entry;\r\n}\r\nexports.parseVModel = parseVModel;\r\n/**\r\n * parseOption - 解析option 主要是赋值\r\n * @param context\r\n * @param VNode\r\n * @param parentElement\r\n */\r\nfunction parseOption(_a) {\r\n    var context = _a.context, VNode = _a.VNode, parentElement = _a.parentElement;\r\n    // v-model的值\r\n    var value = util_1.execExpression.call(this, context, parentElement.getAttribute(constants_1.DIRECT_PREFIX + \"model\"));\r\n    // 获取option的value value表示的是text或value\r\n    var val = VNode.data.props.value;\r\n    // model的值是数组\r\n    if (util_1.isArray(value)) {\r\n        if (value.includes(val)) {\r\n            VNode.data.props.selected = 'selected';\r\n        }\r\n    }\r\n    // model的值不是数组\r\n    else if (val == value) {\r\n        VNode.data.props.selected = 'selected';\r\n    }\r\n}\r\nexports.parseOption = parseOption;\r\n/**\r\n * isFormTag\r\n * @param tagName\r\n * @return {boolean}\r\n */\r\nfunction isFormTag(tagName) {\r\n    return constants_1.FORM_CONTROL_BINDING_TAG_NAMES.includes(tagName);\r\n}\r\nexports.isFormTag = isFormTag;\r\n/**\r\n * filterChain\r\n * @param value\r\n * @param directiveEntry\r\n */\r\nfunction filterChain(value, directiveEntry) {\r\n    var result = value;\r\n    var chains = [\r\n        {\r\n            condition: directiveEntry.modifiers.trim,\r\n            handler: function (val) {\r\n                return val.trim();\r\n            },\r\n        },\r\n        {\r\n            condition: directiveEntry.modifiers.number,\r\n            handler: function (val) {\r\n                return Number(val);\r\n            },\r\n        },\r\n    ];\r\n    chains.forEach(function (_a) {\r\n        var condition = _a.condition, handler = _a.handler;\r\n        if (condition) {\r\n            result = handler(result);\r\n        }\r\n    });\r\n    return result;\r\n}\r\nexports.filterChain = filterChain;\r\n"],"names":["Object","defineProperty","exports","value","filterChain","isFormTag","parseOption","parseVModel","getVModelEntrys","hasVModel","util_1","require","util_2","constants_1","attrNames","hasVAttr","DIRECT_PREFIX","getInputType","context","el","getInputProp","call","this","propName","getInputValue","_a","getAttributeNames","includes","getAttribute","execExpression","hasProp","prop","attrs","vAttrNames","filter","n","indexOf","length","attrName","getDirectiveEntry","tagName","VNode","self","entry","expression","inputType","inputValue","FORM_CONTROL_CHECKED_TAG_NAMES","data","props","checked","isArray","lazy","modifiers","on","change","e","createExecutionContext","selectedOptions","target","$dataProxy","Array","from","map","selectedOption","deleteIndex","push","splice","input","parentElement","val","selected","FORM_CONTROL_BINDING_TAG_NAMES","directiveEntry","result","condition","trim","handler","number","Number","forEach"],"mappings":"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"}