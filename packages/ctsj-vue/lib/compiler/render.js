"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.renderComponentNode=exports.renderDynamicComponentNode=exports.renderSlotNode=exports.renderTemplateNode=exports.renderElementNode=exports.renderTextNode=exports.renderLoop=exports.renderComponent=exports.render=void 0;var util_1=require("../core/util"),util_2=require("../shared/util"),util_3=require("../core/component/util"),proxy_1=require("../core/proxy"),util_4=require("./directives/util"),html_1=require("./directives/html"),if_1=require("./directives/if"),else_1=require("./directives/else"),else_if_1=require("./directives/else-if"),on_1=require("./directives/on"),bind_1=require("./directives/bind"),show_1=require("./directives/show"),for_1=require("./directives/for"),model_1=require("./directives/model"),vdom_1=require("../core/vdom"),uuid_1=__importDefault(require("../shared/uuid")),constants_1=require("../shared/constants");function render(e,t){var n=this,r=(new Date).getTime(),l=renderLoop.call(this,{context:{},el:this.templateEl,parentVNode:null,parentElement:null}),o=(new Date).getTime();return util_2.log("render所用时间"+(o-r)/1e3+"m"),!!l&&(Object.assign(l.data.hook,{init:function(e){e===l&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[1])},create:function(e,t){t===l&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[2])},prepatch:function(e,t){t===l&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[4])},postpatch:function(e,t){t===l&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[5])},destroy:function(e){e===l&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[7])}}),t?(this.$preVNode=vdom_1.patch(e,l),util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[3])):(this.$preVNode||(this.$preVNode=l),t=(new Date).getTime(),this.$preVNode=vdom_1.patch(this.$preVNode,l),e=(new Date).getTime(),util_2.log("patch所用时间"+(e-t)/1e3+"m")),!0)}function renderComponent(){var n=this,r=renderLoop.call(this,{context:{},el:this.templateEl,parentVNode:null,parentElement:null});return r?(Object.assign(r.data.hook,{init:function(e){e===r&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[1])},create:function(e,t){t===r&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[2])},insert:function(e){e===r&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[3])},prepatch:function(e,t){t===r&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[4])},postpatch:function(e,t){t===r&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[5])},destroy:function(e){e===r&&util_1.triggerLifecycle.call(n,constants_1.LIFECYCLE_HOOKS[7])}}),r):null}function renderLoop(e){var t=e.context,n=e.el,r=e.parentVNode,l=e.parentElement;if(util_2.isTextNode(n))return renderTextNode.call(this,{context:t,el:n});var o=!1,e=util_1.isVueInstance(this);if(e)o=util_3.isComponentNodeByVue(n);else{if(!util_3.isComponentInstance(this))return null;o=util_3.isComponentNodeByComponent(n,this.$getComponentsConfig())}return o?renderComponentNode.call(this,{context:t,el:n,parentVNode:r,parentElement:l}):util_2.isTemplateNode(n)?renderTemplateNode.call(this,{context:t,el:n,parentVNode:r,parentElement:l}):!e&&util_2.isSlotNode(n)?renderSlotNode.call(this,{context:t,el:n,parentVNode:r,parentElement:l}):util_2.isDynamicComponentNode(n)?renderDynamicComponentNode.call(this,{context:t,el:n,parentVNode:r,parentElement:l}):util_2.isElementNode(n)?renderElementNode.call(this,{context:t,el:n,parentVNode:r,parentElement:l}):null}function renderTextNode(e){for(var t=e.context,n=e.el.textContent.trim(),r=0,l="";r<n.length;){var o=n.indexOf(constants_1.START_TAG,r);if(-1!==o){var i=n.indexOf(constants_1.END_TAG,o+constants_1.START_TAG.length);if(-1===i){l+=n.substring(r);break}var a=n.substring(o+constants_1.START_TAG.length,i);l+=n.substring(r,o)+util_2.execExpression.call(this,t,a),r=i+constants_1.END_TAG.length}else l+=n.charAt(r++)}return vdom_1.createTextVNode(l)}function renderVAttr(e){var t=e.el,n=e.parentVNode,r=e.parentElement,l=e.context,o=e.renderFun,e=util_4.getVAttrNames(t);if(!e.length)return{Continue:!0,VNode:null};if(for_1.hasVFor(e))return{Continue:!1,VNode:n?for_1.parseVFor.call(this,{context:l,el:t,parentVNode:n,vAttrNames:e,renderFun:o}):null};if(if_1.hasVIf(e)&&!if_1.parseVIf.call(this,{context:l,el:t,vAttrNames:e}))return{Continue:!1,VNode:null};if(else_1.hasVElse(e)){if(!(i=else_1.parseVElse.call(this,{context:l,el:t,parentElement:r})).valid)return{Continue:!1,VNode:null};if(!i.result)return{Continue:!1,VNode:null}}if(else_if_1.hasVElseIf(e)){if(!(i=else_if_1.parseVElseIf.call(this,{context:l,el:t,parentElement:r})).valid)return{Continue:!1,VNode:null};if(!i.result)return{Continue:!1,VNode:null}}var r=t.tagName.toLowerCase(),i=vdom_1.createVNode(r);return show_1.hasVShow(e)&&show_1.parseVShow.call(this,{context:l,el:t,vAttrNames:e,VNode:i}),bind_1.hasVBind(e)&&bind_1.parseVBind.call(this,{context:l,el:t,vAttrNames:e,VNode:i}),constants_1.FORM_CONTROL_BINDING_TAG_NAMES.includes(r)&&model_1.hasVModel(e)&&model_1.parseVModel.call(this,{context:l,tagName:r,vProps:i.data.props,el:t,vAttrNames:e,VNode:i}),on_1.hasVOn(e)&&on_1.parseVOn.call(this,{context:l,el:t,tagName:r,vAttrNames:e,VNode:i}),!model_1.isFormTag(r)&&html_1.hasVHtml(e)&&html_1.parseVHtml.call(this,{context:l,el:t,vAttrNames:e,VNode:i}),{Continue:!0,VNode:i}}function renderAttr(e){var n=e.el,r=e.VNode,l=this,e=util_4.getAttrNames(n);e.length&&e.forEach(function(e){var t=n.getAttribute(e);"key"===e?r.key=t:"ref"===e?Object.assign(r.data.hook,{insert:function(e){l.$refs[t]=e.elm}}):"style"===e?r.data.style[e]=t:"class"===e?r.data.class[t]=!0:e.startsWith("data-")?r.data.dataset[util_2.toCamelCase(e.substring("data-".length))]=t:r.data.attrs[e]=t})}function renderElementNode(e){var t=e.context,n=e.el,r=e.parentVNode,l=e.parentElement;n.normalize();var o=renderVAttr.call(this,{el:n,parentVNode:r,parentElement:l,context:t,renderFun:renderElementNode}),e=o.Continue,i=o.VNode;if(!e)return i;i=i||vdom_1.createVNode(n.tagName.toLowerCase()),renderAttr.call(this,{el:n,VNode:i}),"option"===n.tagName.toLowerCase()&&r&&l&&model_1.parseOption.call(this,{context:t,VNode:i,parentElement:l});for(var a=0,s=n.childNodes.length;a<s;a++){var c=renderLoop.call(this,{context:t,el:n.childNodes[a],parentVNode:i,parentElement:n});c&&(util_2.isArray(c)?c.filter(function(e){return e}).forEach(function(e){i.children.push(e)}):util_2.isObject(c)&&i.children.push(c))}return i}function renderTemplateNode(e){var t,n=e.context,r=e.el,l=e.parentVNode,o=e.parentElement,e=util_4.getVAttrNames(r);if(e.length){if(for_1.hasVFor(e))return for_1.parseVFor.call(this,{context:n,el:r,parentVNode:l,vAttrNames:e,renderFun:renderTemplateNode});if(if_1.hasVIf(e))if(!if_1.parseVIf.call(this,{context:n,el:r,vAttrNames:e}))return null;if(else_1.hasVElse(e)){if(!(t=else_1.parseVElse.call(this,{context:n,el:r,parentElement:o})).valid)return null;if(!t.result)return null}if(else_if_1.hasVElseIf(e)){if(!(t=else_if_1.parseVElseIf.call(this,{context:n,el:r,parentElement:o})).valid)return null;if(!t.result)return null}}for(var i=[],a=0,s=r.content.childNodes.length;a<s;a++){var c=renderLoop.call(this,{context:n,el:r.content.childNodes[a],parentVNode:l,parentElement:r});c&&(util_2.isArray(c)?i=i.concat(c.filter(function(e){return e})):util_2.isObject(c)&&i.push(c))}return i}function renderSlotNode(e){var t,n=e.context,r=e.el,l=e.parentVNode,o=(e.parentElement,"default"),i="parent";util_4.hasAttr("name",r)&&(o=util_4.getAttribute.call(this,{context:n,attrName:"name",el:r}));var a=util_4.getVAttrNames(r);bind_1.hasVBind(a)&&(t=bind_1.getVBindEntrys.call(this,{context:n,el:r,vAttrNames:a}));var s,c,e=Array.from(this.$el.getElementsByTagName("template")),a=e.findIndex(function(e){return e.getAttributeNames().some(function(e){return e.startsWith(constants_1.DIRECT_PREFIX+"slot:"+o)})}),u=null;return-1!==a&&(u=e[a]),u||((u=document.createElement("template")).setAttribute(constants_1.DIRECT_PREFIX+"slot:"+o,""),"default"===o?Array.from(this.$el.childNodes).filter(function(e){return!util_2.isElementNode(e)||"template"!==e.tagName.toLowerCase()||!e.getAttributeNames().some(function(e){return e.startsWith(constants_1.DIRECT_PREFIX+"slot:")})}).forEach(function(e){u.content.appendChild(e)}):(i="self",Array.from(r.childNodes).forEach(function(e){u.content.appendChild(e)}))),"parent"===i?(s=proxy_1.createContext(this.$getParentContext()),c=u.getAttribute(constants_1.DIRECT_PREFIX+"slot:"+o),t&&t.length&&c&&(s[c]={},t.forEach(function(e){s[c][e.arg]=e.value}))):s=n,renderTemplateNode.call(this.$parent,{context:s,el:u,parentVNode:l,parentElement:this.$el})}function renderDynamicComponentNode(e){var t=e.context,n=e.el,r=e.parentVNode,l=e.parentElement,o=util_4.getVAttrNames(n);if(o.length){if(for_1.hasVFor(o))return for_1.parseVFor.call(this,{context:t,el:n,parentVNode:r,vAttrNames:o,renderFun:renderDynamicComponentNode});var i=util_4.getKey.call(this,{context:t,el:n});if(if_1.hasVIf(o))if(!if_1.parseVIf.call(this,{context:t,el:n,vAttrNames:o}))return i&&this.componentsMap.delete(i),null;if(else_1.hasVElse(o)){e=else_1.parseVElse.call(this,{context:t,el:n,parentElement:l});if(!e.valid)return i&&this.componentsMap.delete(i),null;if(!e.result)return i&&this.componentsMap.delete(i),null}if(else_if_1.hasVElseIf(o)){var a=else_if_1.parseVElseIf.call(this,{context:t,el:n,parentElement:l});if(!a.valid)return i&&this.componentsMap.delete(i),null;if(!a.result)return i&&this.componentsMap.delete(i),null}}i=util_4.getKey.call({context:t,el:n});o=util_4.getAttribute.call(this,{context:t,attrName:"is",el:n});if(!o)return null;var a=!1,s=document.createElement(o);if(util_1.isVueInstance(this))a=util_3.isComponentNodeByVue(s);else{if(!util_3.isComponentInstance(this))return null;a=util_3.isComponentNodeByComponent(s,this.$getComponentsConfig())}if(!a)return null;var c=util_4.getAttributeName({attrName:"is",el:n});n.getAttributeNames().filter(function(e){return e!==c&&!e.startsWith(constants_1.DIRECT_PREFIX+"bind:key")&&"key"!==e}).forEach(function(e){return s.setAttribute(e,n.getAttribute(e))}),util_2.isEmpty(i)&&(i=uuid_1.default(),n.setAttribute("key",i),this.componentsMap.set(i,{componentName:o,key:uuid_1.default()}));a=this.componentsMap.get(i);return util_2.isEmpty(a)?this.componentsMap.set(i,{componentName:o,key:uuid_1.default()}):a.componentName!==o&&(this.componentsMap.delete(a.key),a.componentName=o,a.key=uuid_1.default()),a=this.componentsMap.get(i),s.setAttribute("key",a.key),renderComponentNode.call(this,{context:t,el:s,parentVNode:r,parentElement:l})}function renderComponentNode(e){var t=e.context,n=e.el,r=e.parentVNode,l=e.parentElement;n.normalize();var o=this,e=util_4.getVAttrNames(n);if(for_1.hasVFor(e))return for_1.parseVFor.call(this,{context:t,el:n,parentVNode:r,vAttrNames:e,renderFun:renderComponentNode});r=util_4.getKey.call(this,{context:t,el:n});if(if_1.hasVIf(e)&&!if_1.parseVIf.call(this,{context:t,el:n,vAttrNames:e}))return r&&this.componentsMap.delete(r),null;if(else_1.hasVElse(e)){if(!(s=else_1.parseVElse.call(this,{context:t,el:n,parentElement:l})).valid)return r&&this.componentsMap.delete(r),null;if(!s.result)return r&&this.componentsMap.delete(r),null}if(else_if_1.hasVElseIf(e)){if(!(s=else_if_1.parseVElseIf.call(this,{context:t,el:n,parentElement:l})).valid)return r&&this.componentsMap.delete(r),null;if(!s.result)return r&&this.componentsMap.delete(r),null}var i={},a={};bind_1.hasVBind(e)&&bind_1.getVBindEntrys.call(o,{context:t,el:n,vAttrNames:e}).forEach(function(e){var t=e.arg,e=e.value;i[t]=e}),util_4.getAttrEntrys(n).forEach(function(e){var t=e.name,e=e.value;i[t]=e}),model_1.hasVModel(e)&&(s=model_1.getVModelEntrys({el:n,vAttrNames:e}),i.value=util_2.execExpression.call(this,t,s.expression)),on_1.hasVOn(e)&&on_1.getVOnEntrys.call(o,{el:n,vAttrNames:e}).forEach(function(e){var t=e.arg,e=e.expression;a[t]=e}),util_2.isEmpty(r)&&(r=uuid_1.default(),n.setAttribute("key",r));var s=o.componentsMap.get(r),e=i.ref;return"ref"in i&&i.ref&&delete i.ref,s?(e&&(o.$refs[e]=s),s.$setParams({attrs:i,events:a,parentContext:t}),console.log("componentUpdate","update"),s.$update()):(s=util_3.createComponent({attrs:i,events:a,parentContext:t,parent:o,root:util_1.isVueInstance(o)?o:o.$root,el:n,key:r}),e&&(o.$refs[e]=s),o.componentsMap.set(r,s),s.$render())}exports.render=render,exports.renderComponent=renderComponent,exports.renderLoop=renderLoop,exports.renderTextNode=renderTextNode,exports.renderElementNode=renderElementNode,exports.renderTemplateNode=renderTemplateNode,exports.renderSlotNode=renderSlotNode,exports.renderDynamicComponentNode=renderDynamicComponentNode,exports.renderComponentNode=renderComponentNode;
//# sourceMappingURL=render.js.map
