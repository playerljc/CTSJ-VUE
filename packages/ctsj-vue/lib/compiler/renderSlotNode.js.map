{"version":3,"file":"renderSlotNode.js","sources":["compiler/renderSlotNode.js"],"sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.renderSlotNode = void 0;\r\nvar vue_util_1 = require(\"@ctsj/vue-util\");\r\nvar util_1 = require(\"./directives/util\");\r\nvar bind_1 = require(\"./directives/bind\");\r\nvar constants_1 = require(\"../shared/constants\");\r\nvar proxy_1 = require(\"../core/proxy\");\r\nvar renderTemplateNode_1 = require(\"./renderTemplateNode\");\r\n/**\r\n * renderSlotNode - 渲染slot元素\r\n * @param context - Object 上下文对象\r\n * @param el - HtmlElement el元素\r\n * @param parentVNode - VNode 父元素VNode\r\n * @param parentElement - HtmlElement 父元素\r\n * @return VNode | VNodes\r\n *\r\n * --------------------下面是列举的一个例子---------------------\r\n *\r\n * wrap - 比如vue实例的模板\r\n * 元素如果是这样定义的\r\n * 1. 第一种情况 default用<template v-slot:default></template>表示的\r\n * <my-component>\r\n *   <template v-slot:head></template>\r\n *   <template v-slot:footer></template>\r\n *   <template v-slot:default>\r\n *     <div>{{name}}</div>\r\n *     <div>{{sex}}</div>\r\n *     <my-component-inner></my-component-inner>\r\n *   </template>\r\n * </my-component>\r\n *\r\n * 2. 第二种情况 default没用template表示\r\n * <li v-for=\"item in list\">\r\n *   <my-component>\r\n *      <div>{{item.name}}</div>\r\n *      <div>{{item.sex}}</div>\r\n *      <template v-slot:head></template>\r\n *      <template v-slot:footer></template>\r\n *      <my-component-inner></my-component-inner>\r\n *   </my-component>\r\n * </li>\r\n *\r\n * inner - 比如my-component的template模板\r\n * 比如VNode的结构是 my-component的template的内容\r\n * 1.没有循环\r\n * <div>\r\n *   <div></div>\r\n *   <div></div>\r\n *   <slot></slot>\r\n *   <slot name=\"head\"></slot>\r\n *   <slot name=\"footer\"></slot>\r\n *   <template></template>\r\n * </div>\r\n *\r\n * 2.有循环\r\n * <div>\r\n *   <div></div>\r\n *   <div></div>\r\n *   <ul>\r\n *    <li v-for=\"(item,index in list)\">\r\n *      {{item.name}}\r\n *      <slot></slot>\r\n *    </li>\r\n *   </ul>\r\n * </div>\r\n */\r\nfunction renderSlotNode(_a) {\r\n    // this是my-component的实例\r\n    // this.$parent是Vue实例或者是Component实例，应该用this.getParentContext()获取父亲的上下文对象作为调用renderTemplateNode的上下文参数\r\n    // el<slot></slot>的el this.$el是$parent的template中<my-component></my-component>这个el\r\n    var context = _a.context, el = _a.el, parentVNode = _a.parentVNode, parentElement = _a.parentElement;\r\n    // this.$el这个变量需要克隆，因为下面会对这个变量进行操作，这个变量不能改变\r\n    var $elClone = this.$el.cloneNode(true);\r\n    var name = 'default';\r\n    var contextType = 'parent';\r\n    // 判断slot中是否存在name属性\r\n    if (util_1.hasAttr('name', el)) {\r\n        // slot有name属性\r\n        name = util_1.getAttribute.call(this, { context: context, attrName: 'name', el: el });\r\n    }\r\n    var bindEntrys;\r\n    // el可能会有多个v-bind,如果有则是作用域插槽\r\n    var vAttrNames = util_1.getVAttrNames(el);\r\n    if (bind_1.hasVBind(vAttrNames)) {\r\n        bindEntrys = bind_1.getVBindEntrys.call(this, { context: context, el: el, vAttrNames: vAttrNames });\r\n    }\r\n    // 在父亲中寻找指定的<template v-slot:name></template>元素\r\n    var templateEls = Array.from($elClone.getElementsByTagName('template'));\r\n    var slotTemplateElIndex = templateEls.findIndex(function (templateEl) {\r\n        return templateEl\r\n            .getAttributeNames()\r\n            .some(function (attrName) { return attrName.startsWith(constants_1.DIRECT_PREFIX + \"slot:\" + name); });\r\n    });\r\n    var slotTemplateEl = null;\r\n    if (slotTemplateElIndex !== -1) {\r\n        slotTemplateEl = templateEls[slotTemplateElIndex];\r\n    }\r\n    // 如果没有找到<template v-slot:name></template>的元素\r\n    if (!slotTemplateEl) {\r\n        // 如果是default 没有定义<template v-slot:default></template> 则需要自己创建一个template元素\r\n        slotTemplateEl = document.createElement('template');\r\n        slotTemplateEl.setAttribute(constants_1.DIRECT_PREFIX + \"slot:\" + name, '');\r\n        // 如果是default\r\n        if (name === 'default') {\r\n            // 需要在$elClone的childrenNodes排除<template v-slot开头的元素放入自定义template元素中\r\n            Array.from($elClone.childNodes)\r\n                .filter(function (node) {\r\n                if (vue_util_1.isElementNode(node) && node.tagName.toLowerCase() === 'template') {\r\n                    return !node\r\n                        .getAttributeNames()\r\n                        .some(function (attrName) { return attrName.startsWith(constants_1.DIRECT_PREFIX + \"slot:\"); });\r\n                }\r\n                return true;\r\n            })\r\n                .forEach(function (node) {\r\n                slotTemplateEl.content.appendChild(node);\r\n            });\r\n        }\r\n        // 如果没有对应的template对应则使用slot的内部内容作为内容\r\n        else {\r\n            contextType = 'self';\r\n            Array.from(el.childNodes).forEach(function (node) {\r\n                slotTemplateEl.content.appendChild(node);\r\n            });\r\n        }\r\n    }\r\n    var curContext;\r\n    if (contextType === 'parent') {\r\n        // 此处需要对parentContext进行克隆\r\n        curContext = proxy_1.createContext(this.$getParentContext());\r\n        // 判断<template v-slot:名字=\"\"></template>是否有v-slot:名字=\"\"\r\n        var slotTemplateAttrValue_1 = slotTemplateEl.getAttribute(constants_1.DIRECT_PREFIX + \"slot:\" + name);\r\n        // 如果有v-slot:名字=\"\"说明是作用域插槽\r\n        if (bindEntrys && bindEntrys.length && slotTemplateAttrValue_1) {\r\n            // 向parentContext中创建bindEntrys的作用域\r\n            curContext[slotTemplateAttrValue_1] = {};\r\n            bindEntrys.forEach(function (bindEntry) {\r\n                curContext[slotTemplateAttrValue_1][bindEntry.arg] = bindEntry.value;\r\n            });\r\n        }\r\n    }\r\n    else {\r\n        curContext = context;\r\n    }\r\n    // 调用renderTemplateNode方法进行渲染\r\n    return renderTemplateNode_1.renderTemplateNode.call(this.$parent, {\r\n        context: curContext,\r\n        el: slotTemplateEl,\r\n        parentVNode: parentVNode,\r\n        parentElement: $elClone,\r\n    });\r\n}\r\nexports.renderSlotNode = renderSlotNode;\r\n"],"names":["Object","defineProperty","exports","value","renderSlotNode","vue_util_1","require","util_1","bind_1","constants_1","proxy_1","renderTemplateNode_1","_a","bindEntrys","context","el","parentVNode","$elClone","parentElement","this","$el","cloneNode","name","contextType","hasAttr","getAttribute","call","attrName","vAttrNames","getVAttrNames","hasVBind","getVBindEntrys","curContext","slotTemplateAttrValue_1","templateEls","Array","from","getElementsByTagName","slotTemplateElIndex","findIndex","templateEl","getAttributeNames","some","startsWith","DIRECT_PREFIX","slotTemplateEl","document","createElement","setAttribute","childNodes","filter","node","isElementNode","tagName","toLowerCase","forEach","content","appendChild","createContext","$getParentContext","length","bindEntry","arg","renderTemplateNode","$parent"],"mappings":"aACAA,OAAOC,eAAeC,QAAS,aAAc,CAAEC,OAAO,IACtDD,QAAQE,oBAAiB,EACzB,IAAIC,WAAaC,QAAQ,kBACrBC,OAASD,QAAQ,qBACjBE,OAASF,QAAQ,qBACjBG,YAAcH,QAAQ,uBACtBI,QAAUJ,QAAQ,iBAClBK,qBAAuBL,QAAQ,wBA2DnC,SAASF,eAAeQ,GAIpB,IAUIC,EAVAC,EAAUF,EAAGE,QAASC,EAAKH,EAAGG,GAAIC,EAAcJ,EAAGI,YAEnDC,GAFgFL,EAAGM,cAExEC,KAAKC,IAAIC,WAAU,IAC9BC,EAAO,UACPC,EAAc,SAEdhB,OAAOiB,QAAQ,OAAQT,KAEvBO,EAAOf,OAAOkB,aAAaC,KAAKP,KAAM,CAAEL,QAASA,EAASa,SAAU,OAAQZ,GAAIA,KAIpF,IAAIa,EAAarB,OAAOsB,cAAcd,GAClCP,OAAOsB,SAASF,KAChBf,EAAaL,OAAOuB,eAAeL,KAAKP,KAAM,CAAEL,QAASA,EAASC,GAAIA,EAAIa,WAAYA,KAG1F,IAuCII,EAKIC,EA5CJC,EAAcC,MAAMC,KAAKnB,EAASoB,qBAAqB,aACvDC,EAAsBJ,EAAYK,UAAU,SAAUC,GACtD,OAAOA,EACFC,oBACAC,KAAK,SAAUf,GAAY,OAAOA,EAASgB,WAAWlC,YAAYmC,cAAgB,QAAUtB,OAEjGuB,EAAiB,KAoDrB,OAnD6B,IAAzBP,IACAO,EAAiBX,EAAYI,IAG5BO,KAEDA,EAAiBC,SAASC,cAAc,aACzBC,aAAavC,YAAYmC,cAAgB,QAAUtB,EAAM,IAE3D,YAATA,EAEAa,MAAMC,KAAKnB,EAASgC,YACfC,OAAO,SAAUC,GAClB,OAAI9C,WAAW+C,cAAcD,IAAwC,aAA/BA,EAAKE,QAAQC,gBACvCH,EACHV,oBACAC,KAAK,SAAUf,GAAY,OAAOA,EAASgB,WAAWlC,YAAYmC,cAAgB,aAI1FW,QAAQ,SAAUJ,GACnBN,EAAeW,QAAQC,YAAYN,MAKvC5B,EAAc,OACdY,MAAMC,KAAKrB,EAAGkC,YAAYM,QAAQ,SAAUJ,GACxCN,EAAeW,QAAQC,YAAYN,OAK3B,WAAhB5B,GAEAS,EAAatB,QAAQgD,cAAcvC,KAAKwC,qBAEpC1B,EAA0BY,EAAepB,aAAahB,YAAYmC,cAAgB,QAAUtB,GAE5FT,GAAcA,EAAW+C,QAAU3B,IAEnCD,EAAWC,GAA2B,GACtCpB,EAAW0C,QAAQ,SAAUM,GACzB7B,EAAWC,GAAyB4B,EAAUC,KAAOD,EAAU1D,UAKvE6B,EAAalB,EAGVH,qBAAqBoD,mBAAmBrC,KAAKP,KAAK6C,QAAS,CAC9DlD,QAASkB,EACTjB,GAAI8B,EACJ7B,YAAaA,EACbE,cAAeD,IAGvBf,QAAQE,eAAiBA"}