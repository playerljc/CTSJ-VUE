{"version":3,"file":"index.js","sources":["core/component/index.js"],"sourcesContent":["\"use strict\";\r\nvar __assign = (this && this.__assign) || function () {\r\n    __assign = Object.assign || function(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\r\n                t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar on_1 = require(\"../../compiler/directives/on\");\r\nvar renderComponent_1 = require(\"../../compiler/renderComponent\");\r\nvar proxy_1 = require(\"../proxy\");\r\nvar util_1 = require(\"../../shared/util\");\r\nvar util_2 = require(\"./util\");\r\nvar merge_1 = require(\"../merge\");\r\nvar util_3 = require(\"../util\");\r\nvar index_1 = require(\"../index\");\r\nvar constants_1 = require(\"../../shared/constants\");\r\n/**\r\n * getPropsAndAttrs - 获取argConfig中的props和attrs\r\n * @return Object\r\n */\r\nfunction getPropsAndAttrs() {\r\n    // 传递进来的 attrs是k/v形式\r\n    var attrs = this.$argConfig.attrs;\r\n    // 配置定义的\r\n    var props = util_1.cloneDeep(this.$config.props) || [];\r\n    var prop = {};\r\n    var attr = {};\r\n    // props必须是object或者array\r\n    if (util_1.isObject(props) || util_1.isArray(props)) {\r\n        // 如果props是对象则props是keys的集合\r\n        if (util_1.isObject(props)) {\r\n            props = Object.keys(props);\r\n        }\r\n        var model = this.$config.model;\r\n        // 如果用户设置了model选项，且组件设置了v-model\r\n        if (model && 'value' in attrs) {\r\n            if (!props.includes(model.prop)) {\r\n                props.push(model.prop);\r\n                attrs[model.prop] = attrs.value;\r\n                delete attrs.value;\r\n            }\r\n        }\r\n        else if ('value' in attrs && !props.includes('value')) {\r\n            props.push('value');\r\n        }\r\n    }\r\n    // 迭代传递进来的attrs\r\n    Object.keys(attrs).forEach(function (key) {\r\n        // 在props中寻找key是否存在\r\n        // 因为在props中定义的是驼峰形式，而在组件标签中定义的是xxx-xxx-xxx形式，所以prop要转换成驼峰形式\r\n        var index = props.findIndex(function (prop) { return util_2.pascalCaseToKebabCase(prop) === key; });\r\n        if (index !== -1) {\r\n            prop[props[index]] = attrs[key];\r\n        }\r\n        else {\r\n            attr[key] = attrs[key];\r\n        }\r\n    });\r\n    return {\r\n        props: prop,\r\n        attrs: attr,\r\n    };\r\n}\r\n/**\r\n * createEmit - 创建$emit对象\r\n * @return Function\r\n */\r\n// TODO:$emit的事件处理函数\r\nfunction createEmit() {\r\n    var self = this;\r\n    // <my-component v-on:abc=\"xxxxxx\"></my-component>\r\n    /**\r\n     * $emit执行\r\n     * @param eventName string - 事件名称\r\n     * @param argv Array - 事件的参数\r\n     */\r\n    return function (eventName) {\r\n        var events = self.$argConfig.events;\r\n        var argv = [];\r\n        for (var i = 0; i < arguments.length; i++) {\r\n            // arguments.length\r\n            if (i === 0 && eventName)\r\n                continue;\r\n            argv.push(arguments[i]);\r\n        }\r\n        var eventNameFormat = eventName.toLowerCase();\r\n        if (!(eventNameFormat in events))\r\n            return false;\r\n        on_1.executeExecutionContextVOn.call(self.$parent, {\r\n            context: {},\r\n            entry: {\r\n                expression: events[eventNameFormat],\r\n            },\r\n            argv: argv,\r\n        });\r\n    };\r\n}\r\n/**\r\n * Component\r\n * @class Component\r\n * @classdesc 组件\r\n */\r\nvar Component = /** @class */ (function () {\r\n    /**\r\n     * constructor\r\n     * @param config {\r\n     *   attrs: Object - 外层标签所有的属性\r\n     *   events: Object - 外层v-on的值\r\n     *   parentContext: Object - 父亲的上下文对象\r\n     * }\r\n     * @param key - 组件的key\r\n     * @param el - 组件的el元素\r\n     * @param root - vue实例\r\n     * @param parent - 父对象(可能是Vue实例，也肯能是Component实例)\r\n     */\r\n    function Component(config, _a) {\r\n        var key = _a.key, el = _a.el, root = _a.root, parent = _a.parent;\r\n        this.$el = el;\r\n        // Vue实例对象\r\n        this.$root = root;\r\n        // 父对象\r\n        this.$parent = parent;\r\n        // 标签中的key属性值\r\n        this.$key = key;\r\n        // 组件的配置对象\r\n        this.$config = this.$getConfig();\r\n        // 构造函数的配置\r\n        this.$argConfig = config;\r\n        // 创建组件的$emit实例\r\n        this.$emit = createEmit.call(this);\r\n        // 存放所有ref的数据\r\n        this.$refs = {};\r\n        // 获取父亲传递过来的props和attrs\r\n        var _b = getPropsAndAttrs.call(this), props = _b.props, attrs = _b.attrs;\r\n        this.$attes = attrs;\r\n        this.$props = util_1.cloneDeep(props);\r\n        // 创建props的代理\r\n        this.$propsProxy = proxy_1.createPropsProxy.call(this, this.$props);\r\n        // 没有被代理的props + data的合体\r\n        this.$noProxySrcData = __assign(__assign({}, this.$props), util_1.cloneDeep(util_1.isFunction(this.$config.data) ? this.$config.data() : {}));\r\n        // data混入\r\n        merge_1.mergeData.call(this);\r\n        // computed混入\r\n        merge_1.mergeComputed.call(this);\r\n        // beforeCreate\r\n        util_3.triggerLifecycle.call(this, constants_1.LIFECYCLE_HOOKS[0]);\r\n        // dataObserver\r\n        this.$dataProxy = proxy_1.createComponentProxy.call(this, this);\r\n        // mergeProps\r\n        merge_1.mergeProps.call(this, this.$props);\r\n        // methods混入\r\n        merge_1.mergeMethods.call(this);\r\n        // 创建template的el对象\r\n        this.templateEl = util_1.createElement(this.$config.template);\r\n        // 存放组件实例的Map\r\n        this.componentsMap = new Map();\r\n    }\r\n    /**\r\n     * $assignClassAndStyle - 混入class和style\r\n     * @param VNode\r\n     */\r\n    Component.prototype.$assignClassAndStyle = function (VNode) {\r\n        var attrs = this.$argConfig.attrs;\r\n        if (attrs.class) {\r\n            if (util_1.isObject(attrs.class)) {\r\n                Object.assign(VNode.data.class, attrs.class);\r\n            }\r\n            else if (typeof attrs.class === 'string') {\r\n                attrs.class.split(' ').forEach(function (className) {\r\n                    VNode.data.class[className] = true;\r\n                });\r\n            }\r\n        }\r\n        if (attrs.style) {\r\n            if (util_1.isObject(attrs.style)) {\r\n                Object.assign(VNode.data.style, attrs.style);\r\n            }\r\n            else if (typeof attrs.style === 'string') {\r\n                attrs.style.split(';').forEach(function (style) {\r\n                    var entry = style.split(':');\r\n                    VNode.data.style[entry[0]] = entry[1];\r\n                });\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     * $setParams\r\n     * @param config\r\n     */\r\n    Component.prototype.$setParams = function (config) {\r\n        this.$argConfig = config;\r\n    };\r\n    /**\r\n     * $getConfig- 获取组件配置\r\n     * @return Object\r\n     */\r\n    Component.prototype.$getConfig = function () {\r\n        var config = util_2.getComponentConfig(this.$parent, this.$el.tagName.toLowerCase());\r\n        // 这块需要判断是否进行mixin\r\n        return util_3.mixinConfig({\r\n            globalConfig: index_1.getGlobalConfig(),\r\n            mixins: config.mixins || [],\r\n            config: config,\r\n        });\r\n    };\r\n    /**\r\n     * $getComponentsConfig - 获取组件components的配置\r\n     * @return Object\r\n     */\r\n    Component.prototype.$getComponentsConfig = function () {\r\n        var config = this.$getConfig();\r\n        if (!config || !('components' in config) || !config.components)\r\n            return {};\r\n        var components = {};\r\n        Object.keys(config.components).forEach(function (key) {\r\n            // 这块和Vue.register一样\r\n            // xxx-xxx-xxx\r\n            if (util_2.isKebabCase(key)) {\r\n                components[key.toLowerCase()] = config.components[key];\r\n            }\r\n            // AbcDefGhi\r\n            else if (util_2.isPascalCase(key)) {\r\n                components[key.toLowerCase()] = config.components[key];\r\n                components[util_2.pascalCaseToKebabCase(key)] = config.components[key];\r\n            }\r\n        });\r\n        return components;\r\n    };\r\n    /**\r\n     * $getParentContext - 获取父亲的上下文对象\r\n     * @return Object\r\n     */\r\n    Component.prototype.$getParentContext = function () {\r\n        return this.$argConfig.parentContext;\r\n    };\r\n    /**\r\n     * $createAsyncExecContext - 创建一个异步的执行上下文\r\n     * @param callBack - Function 回调的函数\r\n     * @return Function\r\n     */\r\n    Component.prototype.$createAsyncExecContext = function (callBack) {\r\n        var self = this;\r\n        return function () {\r\n            util_1.createExecutionContext.call(self, self, callBack);\r\n        };\r\n    };\r\n    /**\r\n     * $render - 编译这个Component返回这个Component的VNode\r\n     * @return {VNode}\r\n     */\r\n    Component.prototype.$render = function () {\r\n        // 渲染\r\n        // beforeMount\r\n        // render\r\n        // mount\r\n        // 渲染\r\n        var VNode = renderComponent_1.renderComponent.call(this);\r\n        // class和style的处理\r\n        this.$assignClassAndStyle(VNode);\r\n        VNode.key = this.$key;\r\n        return VNode;\r\n    };\r\n    /**\r\n     * $update - 更新这个Component返回这个Component的VNode\r\n     * 更新分为2中\r\n     *  1.父容器更新导致组件的更新(props)\r\n     *    父容器的更新需要调用update方法只返回VNode即可\r\n     *  2.组件内部的更新(data)\r\n     *    组件内部的更新需要调用$root的refresh来执行虚拟Dom的path操作\r\n     * @return {VNode}\r\n     */\r\n    Component.prototype.$update = function () {\r\n        var _this = this;\r\n        // 父容器更新\r\n        var _a = getPropsAndAttrs.call(this), props = _a.props, attrs = _a.attrs;\r\n        this.$attes = attrs;\r\n        // 之前props的keys\r\n        var prePropsKeys = Object.keys(this.$props);\r\n        // 新的props\r\n        this.$props = util_1.cloneDeep(props);\r\n        // 先触发watch\r\n        Object.assign(this.$propsProxy, this.$props);\r\n        // 之前props的keys\r\n        prePropsKeys.forEach(function (key) {\r\n            if (key in _this.$noProxySrcData) {\r\n                delete _this.$noProxySrcData[key];\r\n            }\r\n            if (key in _this) {\r\n                delete _this[key];\r\n            }\r\n        });\r\n        Object.assign(this.$noProxySrcData, this.$props);\r\n        merge_1.mergeProps.call(this, this.$props);\r\n        this.$propsProxy = proxy_1.createPropsProxy.call(this, this.$props);\r\n        // 在这个地方进行watch操作\r\n        // 修改被代理对象的props，而不是修改$dataProxy对象，这样不会触发set\r\n        // 这样写就不能进行watch操作\r\n        // 把之前的props删除，混入现在的props\r\n        merge_1.mergeMethods.call(this);\r\n        util_3.resetComputed.call(this);\r\n        var VNode = renderComponent_1.renderComponent.call(this);\r\n        // class和style的处理\r\n        this.$assignClassAndStyle(VNode);\r\n        VNode.key = this.$key;\r\n        return VNode;\r\n    };\r\n    return Component;\r\n}());\r\nexports.default = Component;\r\n"],"names":["__assign","this","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","defineProperty","exports","value","on_1","require","renderComponent_1","proxy_1","util_1","util_2","merge_1","util_3","index_1","constants_1","getPropsAndAttrs","model","attrs","$argConfig","props","cloneDeep","$config","prop","attr","isObject","isArray","keys","includes","push","forEach","key","index","findIndex","pascalCaseToKebabCase","createEmit","self","eventName","events","argv","eventNameFormat","toLowerCase","executeExecutionContextVOn","$parent","context","entry","expression","Component","config","_a","el","root","parent","$el","$root","$key","$getConfig","$emit","$refs","_b","$attes","$props","$propsProxy","createPropsProxy","$noProxySrcData","isFunction","data","mergeData","mergeComputed","triggerLifecycle","LIFECYCLE_HOOKS","$dataProxy","createComponentProxy","mergeProps","mergeMethods","templateEl","createElement","template","componentsMap","Map","$assignClassAndStyle","VNode","class","split","className","style","$setParams","getComponentConfig","tagName","mixinConfig","globalConfig","getGlobalConfig","mixins","$getComponentsConfig","components","isKebabCase","isPascalCase","$getParentContext","parentContext","$createAsyncExecContext","callBack","createExecutionContext","$render","renderComponent","$update","_this","prePropsKeys","resetComputed","default"],"mappings":"aACA,IAAIA,SAAYC,MAAQA,KAAKD,UAAa,WAStC,OARAA,SAAWE,OAAOC,QAAU,SAASC,GACjC,IAAK,IAAIC,EAAGC,EAAI,EAAGC,EAAIC,UAAUC,OAAQH,EAAIC,EAAGD,IAE5C,IAAK,IAAII,KADTL,EAAIG,UAAUF,GACOJ,OAAOS,UAAUC,eAAeC,KAAKR,EAAGK,KACzDN,EAAEM,GAAKL,EAAEK,IAEjB,OAAON,IAEKU,MAAMb,KAAMO,YAEhCN,OAAOa,eAAeC,QAAS,aAAc,CAAEC,OAAO,IACtD,IAAIC,KAAOC,QAAQ,gCACfC,kBAAoBD,QAAQ,kCAC5BE,QAAUF,QAAQ,YAClBG,OAASH,QAAQ,qBACjBI,OAASJ,QAAQ,UACjBK,QAAUL,QAAQ,YAClBM,OAASN,QAAQ,WACjBO,QAAUP,QAAQ,YAClBQ,YAAcR,QAAQ,0BAK1B,SAASS,mBAEL,IAWQC,EAXJC,EAAQ7B,KAAK8B,WAAWD,MAExBE,EAAQV,OAAOW,UAAUhC,KAAKiC,QAAQF,QAAU,GAChDG,EAAO,GACPC,EAAO,GAgCX,OA9BId,OAAOe,SAASL,IAAUV,OAAOgB,QAAQN,MAErCV,OAAOe,SAASL,KAChBA,EAAQ9B,OAAOqC,KAAKP,KAEpBH,EAAQ5B,KAAKiC,QAAQL,QAEZ,UAAWC,EACfE,EAAMQ,SAASX,EAAMM,QACtBH,EAAMS,KAAKZ,EAAMM,MACjBL,EAAMD,EAAMM,MAAQL,EAAMb,aACnBa,EAAMb,OAGZ,UAAWa,IAAUE,EAAMQ,SAAS,UACzCR,EAAMS,KAAK,UAInBvC,OAAOqC,KAAKT,GAAOY,QAAQ,SAAUC,GAGjC,IAAIC,EAAQZ,EAAMa,UAAU,SAAUV,GAAQ,OAAOZ,OAAOuB,sBAAsBX,KAAUQ,KAC7E,IAAXC,EACAT,EAAKH,EAAMY,IAAUd,EAAMa,GAG3BP,EAAKO,GAAOb,EAAMa,KAGnB,CACHX,MAAOG,EACPL,MAAOM,GAQf,SAASW,aACL,IAAIC,EAAO/C,KAOX,OAAO,SAAUgD,GAGb,IAFA,IAAIC,EAASF,EAAKjB,WAAWmB,OACzBC,EAAO,GACF7C,EAAI,EAAGA,EAAIE,UAAUC,OAAQH,IAExB,IAANA,GAAW2C,GAEfE,EAAKV,KAAKjC,UAAUF,IAExB,IAAI8C,EAAkBH,EAAUI,cAChC,KAAMD,KAAmBF,GACrB,OAAO,EACXhC,KAAKoC,2BAA2BzC,KAAKmC,EAAKO,QAAS,CAC/CC,QAAS,GACTC,MAAO,CACHC,WAAYR,EAAOE,IAEvBD,KAAMA,KASlB,IAAIQ,UAA2B,WAa3B,SAASA,EAAUC,EAAQC,GACvB,IAAIlB,EAAMkB,EAAGlB,IAAKmB,EAAKD,EAAGC,GAAIC,EAAOF,EAAGE,KAAMC,EAASH,EAAGG,OAC1D/D,KAAKgE,IAAMH,EAEX7D,KAAKiE,MAAQH,EAEb9D,KAAKsD,QAAUS,EAEf/D,KAAKkE,KAAOxB,EAEZ1C,KAAKiC,QAAUjC,KAAKmE,aAEpBnE,KAAK8B,WAAa6B,EAElB3D,KAAKoE,MAAQtB,WAAWlC,KAAKZ,MAE7BA,KAAKqE,MAAQ,GAETC,EAAK3C,iBAAiBf,KAAKZ,MAAO+B,EAAQuC,EAAGvC,MAAOF,EAAQyC,EAAGzC,MACnE7B,KAAKuE,OAAS1C,EACd7B,KAAKwE,OAASnD,OAAOW,UAAUD,GAE/B/B,KAAKyE,YAAcrD,QAAQsD,iBAAiB9D,KAAKZ,KAAMA,KAAKwE,QAE5DxE,KAAK2E,gBAAkB5E,SAASA,SAAS,GAAIC,KAAKwE,QAASnD,OAAOW,UAAUX,OAAOuD,WAAW5E,KAAKiC,QAAQ4C,MAAQ7E,KAAKiC,QAAQ4C,OAAS,KAEzItD,QAAQuD,UAAUlE,KAAKZ,MAEvBuB,QAAQwD,cAAcnE,KAAKZ,MAE3BwB,OAAOwD,iBAAiBpE,KAAKZ,KAAM0B,YAAYuD,gBAAgB,IAE/DjF,KAAKkF,WAAa9D,QAAQ+D,qBAAqBvE,KAAKZ,KAAMA,MAE1DuB,QAAQ6D,WAAWxE,KAAKZ,KAAMA,KAAKwE,QAEnCjD,QAAQ8D,aAAazE,KAAKZ,MAE1BA,KAAKsF,WAAajE,OAAOkE,cAAcvF,KAAKiC,QAAQuD,UAEpDxF,KAAKyF,cAAgB,IAAIC,IAuJ7B,OAjJAhC,EAAUhD,UAAUiF,qBAAuB,SAAUC,GACjD,IAAI/D,EAAQ7B,KAAK8B,WAAWD,MACxBA,EAAMgE,QACFxE,OAAOe,SAASP,EAAMgE,OACtB5F,OAAOC,OAAO0F,EAAMf,KAAKgB,MAAOhE,EAAMgE,OAEV,iBAAhBhE,EAAMgE,OAClBhE,EAAMgE,MAAMC,MAAM,KAAKrD,QAAQ,SAAUsD,GACrCH,EAAMf,KAAKgB,MAAME,IAAa,KAItClE,EAAMmE,QACF3E,OAAOe,SAASP,EAAMmE,OACtB/F,OAAOC,OAAO0F,EAAMf,KAAKmB,MAAOnE,EAAMmE,OAEV,iBAAhBnE,EAAMmE,OAClBnE,EAAMmE,MAAMF,MAAM,KAAKrD,QAAQ,SAAUuD,GACjCxC,EAAQwC,EAAMF,MAAM,KACxBF,EAAMf,KAAKmB,MAAMxC,EAAM,IAAMA,EAAM,OASnDE,EAAUhD,UAAUuF,WAAa,SAAUtC,GACvC3D,KAAK8B,WAAa6B,GAMtBD,EAAUhD,UAAUyD,WAAa,WAC7B,IAAIR,EAASrC,OAAO4E,mBAAmBlG,KAAKsD,QAAStD,KAAKgE,IAAImC,QAAQ/C,eAEtE,OAAO5B,OAAO4E,YAAY,CACtBC,aAAc5E,QAAQ6E,kBACtBC,OAAQ5C,EAAO4C,QAAU,GACzB5C,OAAQA,KAOhBD,EAAUhD,UAAU8F,qBAAuB,WACvC,IAAI7C,EAAS3D,KAAKmE,aAClB,KAAKR,GAAY,eAAgBA,GAAYA,EAAO8C,YAChD,MAAO,GACX,IAAIA,EAAa,GAajB,OAZAxG,OAAOqC,KAAKqB,EAAO8C,YAAYhE,QAAQ,SAAUC,GAGzCpB,OAAOoF,YAAYhE,GACnB+D,EAAW/D,EAAIU,eAAiBO,EAAO8C,WAAW/D,GAG7CpB,OAAOqF,aAAajE,KACzB+D,EAAW/D,EAAIU,eAAiBO,EAAO8C,WAAW/D,GAClD+D,EAAWnF,OAAOuB,sBAAsBH,IAAQiB,EAAO8C,WAAW/D,MAGnE+D,GAMX/C,EAAUhD,UAAUkG,kBAAoB,WACpC,OAAO5G,KAAK8B,WAAW+E,eAO3BnD,EAAUhD,UAAUoG,wBAA0B,SAAUC,GACpD,IAAIhE,EAAO/C,KACX,OAAO,WACHqB,OAAO2F,uBAAuBpG,KAAKmC,EAAMA,EAAMgE,KAOvDrD,EAAUhD,UAAUuG,QAAU,WAM1B,IAAIrB,EAAQzE,kBAAkB+F,gBAAgBtG,KAAKZ,MAInD,OAFAA,KAAK2F,qBAAqBC,GAC1BA,EAAMlD,IAAM1C,KAAKkE,KACV0B,GAWXlC,EAAUhD,UAAUyG,QAAU,WAC1B,IAAIC,EAAQpH,KAER4D,EAAKjC,iBAAiBf,KAAKZ,MAAO+B,EAAQ6B,EAAG7B,MAAOF,EAAQ+B,EAAG/B,MACnE7B,KAAKuE,OAAS1C,EAEVwF,EAAepH,OAAOqC,KAAKtC,KAAKwE,QAEpCxE,KAAKwE,OAASnD,OAAOW,UAAUD,GAE/B9B,OAAOC,OAAOF,KAAKyE,YAAazE,KAAKwE,QAErC6C,EAAa5E,QAAQ,SAAUC,GACvBA,KAAO0E,EAAMzC,wBACNyC,EAAMzC,gBAAgBjC,GAE7BA,KAAO0E,UACAA,EAAM1E,KAGrBzC,OAAOC,OAAOF,KAAK2E,gBAAiB3E,KAAKwE,QACzCjD,QAAQ6D,WAAWxE,KAAKZ,KAAMA,KAAKwE,QACnCxE,KAAKyE,YAAcrD,QAAQsD,iBAAiB9D,KAAKZ,KAAMA,KAAKwE,QAK5DjD,QAAQ8D,aAAazE,KAAKZ,MAC1BwB,OAAO8F,cAAc1G,KAAKZ,MACtB4F,EAAQzE,kBAAkB+F,gBAAgBtG,KAAKZ,MAInD,OAFAA,KAAK2F,qBAAqBC,GAC1BA,EAAMlD,IAAM1C,KAAKkE,KACV0B,GAEJlC,EA5MmB,GA8M9B3C,QAAQwG,QAAU7D"}