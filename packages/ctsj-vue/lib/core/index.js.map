{"version":3,"file":"index.js","sources":["core/index.js"],"sourcesContent":["\"use strict\";\r\nvar __assign = (this && this.__assign) || function () {\r\n    __assign = Object.assign || function(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\r\n                t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.getGlobalConfig = void 0;\r\nvar vue_util_1 = require(\"@ctsj/vue-util\");\r\nvar routeHooks_1 = require(\"@ctsj/vue-router/lib/routeHooks\");\r\nvar util_1 = require(\"../shared/util\");\r\nvar vdom_1 = require(\"./vdom\");\r\nvar register_1 = require(\"./component/register\");\r\nvar render_1 = require(\"../compiler/render\");\r\nvar constants_1 = require(\"../shared/constants\");\r\nvar merge_1 = require(\"./merge\");\r\nvar util_2 = require(\"./util\");\r\nvar proxy_1 = require(\"./proxy\");\r\nvar proxyDirtyStack_1 = __importDefault(require(\"../compiler/proxyDirtyStack\"));\r\n/**\r\n * findVNodeParentByKey - 查询key的Parent\r\n * @param VNode - 当前节点\r\n * @param key - 查询的key\r\n * @return {VNode}\r\n */\r\nfunction findVNodeParentByKey(VNode, key) {\r\n    if (!VNode || VNode.key === key) {\r\n        return null;\r\n    }\r\n    var parent = null;\r\n    if (!('children' in VNode) || !VNode.children)\r\n        return null;\r\n    for (var i = 0; i < VNode.children.length; i++) {\r\n        var curVNode = VNode.children[i];\r\n        if (!curVNode)\r\n            continue;\r\n        if (curVNode.key === key) {\r\n            parent = VNode;\r\n            break;\r\n        }\r\n        else if ('children' in curVNode && curVNode.children) {\r\n            parent = findVNodeParentByKey.call(this, curVNode, key);\r\n            if (parent)\r\n                break;\r\n        }\r\n    }\r\n    return parent;\r\n}\r\n// 全局的配置对象\r\nvar _globalConfig = {};\r\n// 存放所有注册的插件\r\nvar _plugins = [];\r\n/**\r\n * getGlobalConfig - 获取全局的配置对象\r\n * @return {Object}\r\n */\r\nfunction getGlobalConfig() {\r\n    return __assign({}, _globalConfig);\r\n}\r\nexports.getGlobalConfig = getGlobalConfig;\r\n/**\r\n * Vue\r\n * @class Vue\r\n * @classdesc Vue实例\r\n */\r\nvar Vue = /** @class */ (function () {\r\n    // static extend() {}\r\n    /**\r\n     * constructor\r\n     * @param config - Object\r\n     */\r\n    function Vue(config) {\r\n        var _this = this;\r\n        // $config - Vue的配置对象\r\n        // 这块需要判断是否进行mixin\r\n        this.$config = util_2.mixinConfig({\r\n            globalConfig: getGlobalConfig(),\r\n            mixins: config.mixins || [],\r\n            config: config,\r\n        });\r\n        // 获取Vue配置中的el实际对象，el可以是HtmlElement或String\r\n        this.$config.el = util_2.getEl(this.$config.el);\r\n        // 存放所有ref的数据\r\n        this.$refs = {};\r\n        // 路由对象的引用\r\n        this.$router = this.$config.router;\r\n        // 给router(路由的对象)设置vue实例对象\r\n        if (this.$router && vue_util_1.isFunction(this.$router.$setVueIns)) {\r\n            this.$router.$setVueIns(this);\r\n        }\r\n        // proxy的脏数据栈\r\n        this.$proxyDirtyStack = new proxyDirtyStack_1.default();\r\n        // 纯净的data数据，没有进行代理的，在watch中使用\r\n        this.$noProxySrcData = vue_util_1.cloneDeep(vue_util_1.isFunction(this.$config.data) ? this.$config.data() : {});\r\n        // 将data混入到this中\r\n        merge_1.mergeData.call(this);\r\n        // 将computed混入到this中\r\n        merge_1.mergeComputed.call(this);\r\n        // ------ beforeCreate\r\n        // 在实例初始化之后，数据观测 (data observer) 和 event/watcher 事件配置之前被调用。------这里是vue文档写的\r\n        util_2.triggerLifecycle.call(this, constants_1.LIFECYCLE_HOOKS[0]);\r\n        // data observer - 数据响应式创建针对data和computed的响应式\r\n        // 被响应式的数据有data | computed\r\n        this.$dataProxy = proxy_1.createVueProxy.call(this, this);\r\n        // 将methods混入到this中\r\n        merge_1.mergeMethods.call(this);\r\n        // 创建template(模板)的el对象templateEl，一个Vue实例只建立一次\r\n        this.templateEl = vue_util_1.createElement(this.$config.template);\r\n        // 存放组件实例的Map\r\n        this.componentsMap = new Map();\r\n        var to = \"\" + window.location.pathname + window.location.search;\r\n        // 需要进行路由守卫的操作\r\n        routeHooks_1.guard({\r\n            fullPath: to,\r\n        }, this.$router).then(function () {\r\n            // 清空匹配数据\r\n            routeHooks_1.clear();\r\n            // 渲染\r\n            render_1.render.call(_this, _this.$config.el, true);\r\n        });\r\n    }\r\n    /**\r\n     * component - 全局注册组件(在任何地方都可以使用)\r\n     * @param componentName - string 注册的组件名称\r\n     *          分为 kebab-case(xxx-xxx-xxx) PascalCase(AbcDef) 两种的形式\r\n     *          如果使用kebab-case进行的注册 则只能使用kebab-case进行使用\r\n     *          如果使用PascalCase进行的注册 则使用kebab-case和PascalCase都可以\r\n     *          例：\r\n     *          注册：Vue.component('my-component',{});\r\n     *          使用：<my-component>\r\n     *\r\n     *          注册 Vue.component('MyComponent',{});\r\n     *          使用 <my-component> 或 <MyComponent>\r\n     * @param config - Object 组件的配置\r\n     */\r\n    Vue.component = function (componentName, config) {\r\n        // 使用kebab-case进行注册(xxx-xxx-xxx) componentName需要转换成小写 xxx-xxx-xxx不变\r\n        if (util_1.isKebabCase(componentName)) {\r\n            register_1.register(componentName.toLowerCase(), config);\r\n        }\r\n        // 使用PascalCase进行注册(AbcDef) componentName需要转换成小写 XxxXxx转换成xxxxxx\r\n        else if (util_1.isPascalCase(componentName)) {\r\n            // 使用xxxxxx进行注册\r\n            register_1.register(componentName.toLowerCase(), config);\r\n            // 使用xxx-xxx-xxx进行注册\r\n            register_1.register(util_1.pascalCaseToKebabCase(componentName), config);\r\n        }\r\n    };\r\n    /**\r\n     * mixin - 全局配置的混入\r\n     * 之后创建的所有Vue实例和Component实例都会进行全局的混入\r\n     * @param Object - globalConfig 全局的混入对象\r\n     */\r\n    Vue.mixin = function (globalConfig) {\r\n        _globalConfig = globalConfig;\r\n    };\r\n    /**\r\n     * use - 注册全局插件\r\n     * @param plugin Object | Function\r\n     * @return boolean\r\n     */\r\n    Vue.use = function (plugin) {\r\n        if (!plugin)\r\n            return false;\r\n        // 已经注册鼓了\r\n        if (_plugins.indexOf(plugin) !== -1)\r\n            return false;\r\n        // 如果plugin是对象\r\n        if (vue_util_1.isObject(plugin)) {\r\n            if ('install' in plugin && vue_util_1.isFunction(plugin.install)) {\r\n                plugin.install(Vue);\r\n                _plugins.push(plugin);\r\n                return true;\r\n            }\r\n            return false;\r\n        }\r\n        // 如果plugin是函数\r\n        if (vue_util_1.isFunction(plugin)) {\r\n            plugin(Vue);\r\n            _plugins.push(plugin);\r\n            return true;\r\n        }\r\n        return false;\r\n    };\r\n    /**\r\n     * $createAsyncExecContext - 创建一个异步的执行上下文\r\n     * @param callBack - Function 回调的函数\r\n     * @return Function\r\n     */\r\n    Vue.prototype.$createAsyncExecContext = function (callBack) {\r\n        var self = this;\r\n        return function () {\r\n            util_1.createExecutionContext.call(self, self, callBack);\r\n        };\r\n    };\r\n    /**\r\n     * $refresh - 指定VNode刷新\r\n     * @param VNode - VNode 这个VNode应该是一个组件的VNode\r\n     */\r\n    Vue.prototype.$refresh = function (VNode) {\r\n        // this.$preVNode\r\n        var cloneNode = vue_util_1.cloneDeep(this.$preVNode);\r\n        var parent = findVNodeParentByKey.call(this, cloneNode, VNode.key);\r\n        if (parent) {\r\n            var index = parent.children.findIndex(function (node) { return node.key === VNode.key; });\r\n            if (index !== -1) {\r\n                parent.children[index] = VNode;\r\n                this.$preVNode = vdom_1.patch(this.$preVNode, cloneNode);\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     * $forceUpdate - Vue实例重新渲染\r\n     * @return boolean\r\n     */\r\n    Vue.prototype.$forceUpdate = function () {\r\n        // 渲染\r\n        return render_1.render.call(this, this.$config.el, false);\r\n    };\r\n    return Vue;\r\n}());\r\nexports.default = Vue;\r\n"],"names":["__assign","this","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","__importDefault","mod","__esModule","default","defineProperty","exports","value","getGlobalConfig","vue_util_1","require","routeHooks_1","util_1","vdom_1","register_1","render_1","constants_1","merge_1","util_2","proxy_1","proxyDirtyStack_1","findVNodeParentByKey","VNode","key","parent","children","curVNode","_globalConfig","_plugins","Vue","config","_this","$config","mixinConfig","globalConfig","mixins","el","getEl","$refs","$router","router","isFunction","$setVueIns","$proxyDirtyStack","$noProxySrcData","cloneDeep","data","mergeData","mergeComputed","triggerLifecycle","LIFECYCLE_HOOKS","$dataProxy","createVueProxy","mergeMethods","templateEl","createElement","template","componentsMap","Map","to","window","location","pathname","search","guard","fullPath","then","clear","render","component","componentName","isKebabCase","register","toLowerCase","isPascalCase","pascalCaseToKebabCase","mixin","use","plugin","indexOf","isObject","install","push","$createAsyncExecContext","callBack","self","createExecutionContext","$refresh","index","cloneNode","$preVNode","findIndex","node","patch","$forceUpdate"],"mappings":"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"}