"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,r=1,o=arguments.length;r<o;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},__spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,r=arguments.length;e<r;e++)t+=arguments[e].length;for(var o=Array(t),n=0,e=0;e<r;e++)for(var a=arguments[e],i=0,u=a.length;i<u;i++,n++)o[n]=a[i];return o},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});var _beforeEachHandler,_afterEachHandler,_errorHandler,path_to_regexp_1=__importDefault(require("path-to-regexp")),vue_util_1=require("@ctsj/vue-util"),constants_1=require("./constants"),qs_1=require("./qs"),routeHooks_1=require("./routeHooks"),util_1=require("./util");function getConfig(t){var e,r={};for(e in t)Object.defineProperty(r,e,{writable:!1,value:t[e]});return r}function linkRoutes(t){for(var e=0;e<t.length;e++)linkRouteLoop(t[e])}function linkRouteLoop(t){for(var e=0,r=(t.children||[]).length;e<r;e++){var o=t.children[e];o.parent=t,linkRouteLoop(o)}}function createRoute(t){var e=t.route,r=t.paramMap,t=t.name;return{path:util_1.getCurRoutePath(e),params:r,query:qs_1.parse(),hash:window.location.hash,fullPath:window.location.href,matched:vue_util_1.cloneDeep(e),name:t,redirectedFrom:""}}function createProps(t){var e=t.detail,t=t.props;return vue_util_1.isBoolean(t)&&t?__assign({},e.params):vue_util_1.isObject(t)?__assign({},t):vue_util_1.isFunction(t)?t(__assign({},e)):null}function createPath(t){if(vue_util_1.isEmpty(t))return"";if(vue_util_1.isString(t))return t;if(vue_util_1.isObject(t)){var e=t.name,r=t.params,o=void 0===r?{}:r,n=t.query,r=void 0===n?{}:n,n=this.$config.routes,n=void 0===n?[]:n;if("name"in t&&!vue_util_1.isEmpty(e)){e=findRouteByName(n||[],e);if(e){var a=util_1.getCurRoutePath(e);return a=""+(a=path_to_regexp_1.default.compile(a,{encode:encodeURIComponent})(o||{}))+qs_1.stringify(r||{})}}if("path"in t&&!vue_util_1.isEmpty(t.path))return a=""+(a=t.path)+qs_1.stringify(r||{})}return""}function findRouteByName(t,e){for(var r,o=0,n=(t||[]).length;o<n;o++){var a=t[o];if("name"===a.name){r=a;break}if(r=findRouteByName(a.children||[],e))break}return r}function onPopstate(){var t=this,e=""+window.location.pathname+window.location.search,r=routeHooks_1.getMatchData().find(function(t){return t.path===e}),r=r?{path:r.path,fullPath:e,name:r.name,params:r.params,query:r.query,hash:r.hash}:{fullPath:e};routeHooks_1.guard(r,this).then(function(){routeHooks_1.clear(),t.$root.$forceUpdate()})}function historyChange(t){var e=t.location,o=t.onComplete,n=t.onAbort,a=t.historyChangeCallback,i=this,r=window.location,u=r.pathname,t=r.search,s=createPath.call(i,e),r=routeHooks_1.getTop(),c=__assign(__assign({},e),{fullPath:s}),r={path:r.path,fullPath:""+u+t,name:r.name,params:r.params,query:r.query,hash:r.hash};return i.currentRoute={from:r,to:c},new Promise(function(e,r){routeHooks_1.guard(c,i).then(function(){var t;a(c),routeHooks_1.clear(),i.$root.$forceUpdate()?(o&&o(),(t=i.getAfterEachHandler())&&t(s,u),e()):(n&&n(),r())})})}var VueRouter=function(){function t(t){this.$config=getConfig(__assign({base:constants_1.PATH_SPLIT},t)),linkRoutes(this.$config.routes||[]),onPopstate=onPopstate.bind(this),window.addEventListener("popstate",onPopstate)}return t.prototype.$destory=function(){window.removeEventListener("popstate",onPopstate)},t.prototype.$setVueIns=function(t){this.$root=t},t.prototype.$getComponentIsVueIns=function(p){for(var h,l=window.location.pathname,t=this.$config,f=t.routes,_=t.base,e=0,r=(f||[]).length;e<r;e++)if("break"===function(t){var e=f[t],r=e.path,o=e.component,n=e.components,a=e.name,i=void 0===a?"":a,u=e.props,a=[],e=util_1.wrapPathByBase(_,r),r=path_to_regexp_1.default(e,a,{sensitive:!1,strict:!1,end:"exact"in f[t],delimiter:"/"});if(r.test(l)){var s={},c=r.exec(l);a.forEach(function(t,e){t=t.name;s[t]=c[e+1]});o=p&&n?n[p]:o,i=createRoute({route:f[t],paramMap:s,name:i});return h={component:o,detail:i,route:f[t],props:createProps({detail:i,props:u}),path:e,regexp:r},"break"}}(e))break;return h},t.prototype.$getComponentIsComIns=function(t,c){for(var p,h=window.location.pathname,e=t.children,l=void 0===e?[]:e,e=this.$config.base,f=util_1.wrapPathByBase(e,util_1.getCurRoutePath(t)),r=0,o=(l||[]).length;r<o;r++)if("break"===function(t){var e=l[t],r=e.path,o=e.component,n=e.components,a=e.props,i=[],e=""+f+r;f.endsWith(constants_1.PATH_SPLIT)?r.startsWith(constants_1.PATH_SPLIT)&&(e=""+f+r.substring(1)):r.startsWith(constants_1.PATH_SPLIT)||(e=f+"/"+r);r=path_to_regexp_1.default(e,i,{sensitive:!1,strict:!1,end:"exact"in l[t],delimiter:constants_1.PATH_SPLIT});if(r.test(h)){var u={},s=r.exec(h);i.forEach(function(t,e){t=t.name;u[t]=s[e+1]});n=c&&n?n[c]:o,o=createRoute({route:l[t],paramMap:u});return p={component:n,detail:o,route:l[t],props:createProps({detail:o,props:a}),path:e,regexp:r},"break"}}(r))break;return p},t.prototype.createPath=function(t){return createPath.call(this,t)},t.prototype.push=function(e,t,r){return historyChange.call(this,{location:e,onComplete:t,onAbort:r,historyChangeCallback:function(t){window.history.pushState({location:e,toRoute:t},t.fullPath,t.fullPath)}})},t.prototype.replace=function(e,t,r){return historyChange.call(this,{location:e,onComplete:t,onAbort:r,historyChangeCallback:function(t){window.history.replaceState({location:e,toRoute:t},t.fullPath,t.fullPath)}})},t.prototype.beforeEach=function(t){_beforeEachHandler=t},t.prototype.afterEach=function(t){_afterEachHandler=t},t.prototype.onError=function(t){_errorHandler=t},t.prototype.getBeforeEachHandler=function(){return _beforeEachHandler},t.prototype.getAfterEachHandler=function(){return _afterEachHandler},t.prototype.getErrorHandler=function(){return _errorHandler},t.prototype.go=function(t){window.history.go(t)},t.prototype.back=function(){window.history.back()},t.prototype.forward=function(){window.history.forward()},t.prototype.insertRoute=function(t){var e=t.curRoute,r=t.index,o=t.route,t=e||this.$config;"children"in t&&vue_util_1.isArray(t.children)&&(-1===r?this.unshiftRoute({curRoute:e,route:o}):r>=t.children.length?this.pushRoute({curRoute:e,route:o}):vue_util_1.isArray(o)?(e=t.children).splice.apply(e,__spreadArrays([r,0],o)):t.children.splice(r,0,o))},t.prototype.pushRoute=function(t){var e=t.curRoute,t=t.route,e=e||this.$config;"children"in e&&vue_util_1.isArray(e.children)&&(vue_util_1.isObject(t)&&e.children.push(t),vue_util_1.isArray(t)&&(e.children=e.children.concat(t)))},t.prototype.unshiftRoute=function(t){var e=t.curRoute,t=t.route,e=e||this.$config;"children"in e&&vue_util_1.isArray(e.children)&&(vue_util_1.isObject(t)&&e.children.unshift(t),vue_util_1.isArray(t)&&(e.children=t.concat(e.children)))},t}();exports.default=VueRouter;
//# sourceMappingURL=index.js.map
