"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.renderComponentNode=exports.renderDynamicComponentNode=exports.renderSlotNode=exports.renderTemplateNode=exports.renderElementNode=exports.renderTextNode=exports.renderLoop=exports.renderComponent=exports.render=void 0;var util_1=require("../core/util"),util_2=require("../shared/util"),util_3=require("../core/component/util"),proxy_1=require("../core/proxy"),util_4=require("./directives/util"),html_1=require("./directives/html"),if_1=require("./directives/if"),on_1=require("./directives/on"),bind_1=require("./directives/bind"),show_1=require("./directives/show"),for_1=require("./directives/for"),model_1=require("./directives/model"),vdom_1=require("../core/vdom"),uuid_1=__importDefault(require("../shared/uuid")),constants_1=require("../shared/constants");function render(e,t){console.log("render");var r=this,n=renderLoop.call(this,this.$dataProxy,this.templateEl);n.data.hook={init:function(e){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[1])},create:function(e,t){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[2])},insert:function(e){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[3])},prepatch:function(){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[4])},postpatch:function(){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[5])},destroy:function(){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[7])}},t?(this.$preVNode=n,this.$preVNode=vdom_1.patch(e,n)):this.$preVNode=vdom_1.patch(this.$preVNode,n)}function renderComponent(){var r=this,e=renderLoop.call(this,this.$dataProxy,this.templateEl);return e.data.hook={init:function(e){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[1])},create:function(e,t){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[2])},insert:function(e){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[3])},prepatch:function(){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[4])},postpatch:function(){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[5])},destroy:function(){util_1.triggerLifecycle.call(r,constants_1.LIFECYCLE_HOOKS[7])}},e}function renderLoop(e,t){if(util_2.isTextNode(t))return renderTextNode.call(this,e,t);var r=!1,n=util_1.isVueInstance(this);if(n)r=util_3.isComponentNodeByVue(t);else{if(!util_3.isComponentInstance(this))return null;r=util_3.isComponentNodeByComponent(t,this.getComponentsConfig())}return r?renderComponentNode.call(this,e,t):util_2.isTemplateNode(t)?renderTemplateNode.call(this,e,t):!n&&util_2.isSlotNode(t)?renderSlotNode.call(this,e,t):util_2.isDynamicComponentNode(t)?renderDynamicComponentNode.call(this,e,t):util_2.isElementNode(t)?renderElementNode.call(this,e,t):null}function renderTextNode(e,t){for(var r=t.textContent.trim(),n=0,o="";n<r.length;){var i=r.indexOf(constants_1.START_TAG,n);if(-1!==i){var a=r.indexOf(constants_1.END_TAG,i+constants_1.START_TAG.length);if(-1===a){o+=r.substring(n);break}var s=r.substring(i+constants_1.START_TAG.length,a);o+=r.substring(n,i)+util_2.execExpression.call(this,e,s),n=a+constants_1.END_TAG.length}else o+=r.charAt(n++)}return vdom_1.createTextVNode(o)}function renderVAttr(e){var t=e.el,r=e.context,n=e.renderFun,o=util_4.getVAttrNames(t);if(!o.length)return{Continue:!0,VNode:null};if(for_1.hasVFor(o))return{Continue:!1,VNode:for_1.parseVFor.call(this,{context:r===this.$dataProxy?proxy_1.createContext(this.$dataProxy):r,el:t,vAttrNames:o,renderFun:n})};if(if_1.hasVIf(o)&&!if_1.parseVIf({context:r,el:t,vAttrNames:o}))return{Continue:!1,VNode:null};e=t.tagName.toLowerCase(),n=vdom_1.createVNode(e);return show_1.hasVShow(o)&&show_1.parseVShow({context:r,el:t,vAttrNames:o,VNode:n}),bind_1.hasVBind(o)&&bind_1.parseVBind({context:r,el:t,vAttrNames:o,VNode:n}),constants_1.FORM_CONTROL_BINDING_TAG_NAMES.includes(e)&&model_1.hasVModel(o)&&model_1.parseVModel.call(this,{context:r,tagName:e,vProps:n.data.props,el:t,vAttrNames:o,VNode:n}),on_1.hasVOn(o)&&on_1.parseVOn.call(this,{context:r,el:t,tagName:e,vAttrNames:o,VNode:n}),!model_1.isFormTag(e)&&html_1.hasVHtml(o)&&html_1.parseVHtml({context:r,el:t,vAttrNames:o,VNode:n}),{Continue:!0,VNode:n}}function renderAttr(e){var r=e.el,n=e.VNode,e=util_4.getAttrNames(r);e.length&&e.forEach(function(e){var t=r.getAttribute(e);"key"===e?n.key=t:e.startsWith("data-")?n.data.dataset[util_2.toCamelCase(e.substring("data-".length))]=t:n.data.attrs[e]=t})}function renderElementNode(e,t){t.normalize();var r=renderVAttr.call(this,{el:t,context:e,renderFun:renderElementNode}),n=r.Continue,o=r.VNode;if(!n)return o;o=o||vdom_1.createVNode(t.tagName.toLowerCase()),renderAttr.call(this,{el:t,VNode:o});for(var i=0,a=t.childNodes.length;i<a;i++){var s=renderLoop.call(this,e,t.childNodes[i]);s&&(util_2.isArray(s)?s.filter(function(e){return e}).forEach(function(e){o.children.push(e)}):util_2.isObject(s)&&o.children.push(s))}return o}function renderTemplateNode(e,t){var r=util_4.getVAttrNames(t);if(r.length){if(for_1.hasVFor(r))return for_1.parseVFor.call(this,{context:e===this.$dataProxy?proxy_1.createContext(this.$dataProxy):e,el:t,vAttrNames:r,renderFun:renderTemplateNode});if(if_1.hasVIf(r))if(!if_1.parseVIf({context:e,el:t,vAttrNames:r}))return null}for(var n=[],o=0,i=t.content.childNodes.length;o<i;o++){var a=renderLoop.call(this,e,t.content.childNodes[o]);a&&(util_2.isArray(a)?n=n.concat(a):util_2.isObject(a)&&n.push(a))}return n}function renderSlotNode(e,t){var r,n="default",o="parent";t.hasAttribute("name")&&(n=t.getAttribute("name"));var i=util_4.getVAttrNames(t);bind_1.hasVBind(i)&&(r=bind_1.getVBindEntrys({context:e,el:t,vAttrNames:i}));var a,s,l=Array.from(this.$el.getElementsByTagName("template")),i=l.findIndex(function(e){return e.getAttributeNames().some(function(e){return e.startsWith(constants_1.DIRECT_PREFIX+"slot:"+n)})}),d=null;return-1!==i&&(d=l[i]),d||((d=document.createElement("template")).setAttribute(constants_1.DIRECT_PREFIX+"slot:"+n,""),"default"===n?Array.from(this.$el.childNodes).filter(function(e){return!util_2.isElementNode(e)||"template"!==e.tagName.toLowerCase()||!e.getAttributeNames().some(function(e){return e.startsWith(constants_1.DIRECT_PREFIX+"slot:")})}).forEach(function(e){d.content.appendChild(e)}):(o="self",Array.from(t.childNodes).forEach(function(e){d.content.appendChild(e)}))),"parent"===o?(a=proxy_1.createContext(this.getParentContext()),s=d.getAttribute(constants_1.DIRECT_PREFIX+"slot:"+n),r&&r.length&&s&&(a[s]={},r.forEach(function(e){a[s][e.arg]=e.value}))):a=e,renderTemplateNode.call(this.$parent,a,d)}function renderDynamicComponentNode(e,t){var r=util_4.getVAttrNames(t);if(r.length){if(for_1.hasVFor(r))return for_1.parseVFor.call(this,{context:e===this.$dataProxy?proxy_1.createContext(this.$dataProxy):e,el:t,vAttrNames:r,renderFun:renderDynamicComponentNode});var n=util_4.getKey({context:e,el:t});if(if_1.hasVIf(r))if(!if_1.parseVIf({context:e,el:t,vAttrNames:r}))return n&&this.componentsMap.delete(n),null}n=util_4.getKey({context:e,el:t});var o=util_4.getAttribute({context:e,attrName:"is",el:t});if(!o)return null;var r=!1,i=document.createElement(o);if(util_1.isVueInstance(this))r=util_3.isComponentNodeByVue(i);else{if(!util_3.isComponentInstance(this))return null;r=util_3.isComponentNodeByComponent(i,this.getComponentsConfig())}if(!r)return null;var a=util_4.getAttributeName({attrName:"is",el:t});t.getAttributeNames().filter(function(e){return e!==a&&!e.startsWith(constants_1.DIRECT_PREFIX+"bind:key")&&"key"!==e}).forEach(function(e){return i.setAttribute(e,t.getAttribute(e))}),util_2.isEmpty(n)&&(n=uuid_1.default(),t.setAttribute("key",n),this.componentsMap.set(n,{componentName:o,key:uuid_1.default()}));r=this.componentsMap.get(n);return util_2.isEmpty(r)?this.componentsMap.set(n,{componentName:o,key:uuid_1.default()}):r.componentName!==o&&(this.componentsMap.delete(r.key),r.componentName=o,r.key=uuid_1.default()),r=this.componentsMap.get(n),i.setAttribute("key",r.key),renderComponentNode.call(this,e,i)}function renderComponentNode(e,t){t.normalize();var r=this,n=util_4.getVAttrNames(t);if(for_1.hasVFor(n))return for_1.parseVFor.call(this,{context:e===this.$dataProxy?proxy_1.createContext(this.$dataProxy):e,el:t,vAttrNames:n,renderFun:renderComponentNode});var o=util_4.getKey({context:e,el:t});if(if_1.hasVIf(n)&&!if_1.parseVIf({context:e,el:t,vAttrNames:n}))return o&&this.componentsMap.delete(o),null;var i,a={},s={};bind_1.hasVBind(n)&&bind_1.getVBindEntrys({context:e,el:t,vAttrNames:n}).forEach(function(e){var t=e.arg,e=e.value;a[t]=e}),util_4.getAttrEntrys(t).forEach(function(e){var t=e.name,e=e.value;a[t]=e}),model_1.hasVModel(n)&&(i=model_1.getVModelEntrys({el:t,vAttrNames:n}),a.value=util_2.execExpression(e,i.expression)),on_1.hasVOn(n)&&on_1.getVOnEntrys.call(r,{el:t,vAttrNames:n}).forEach(function(e){var t=e.arg,e=e.expression;s[t]=e}),util_2.isEmpty(o)&&(o=uuid_1.default(),t.setAttribute("key",o));n=r.componentsMap.get(o);return n?(n.setParams({attrs:a,events:s,parentContext:e}),n.update()):(n=util_3.createComponent({attrs:a,events:s,parentContext:e,parent:r,top:util_1.isVueInstance(r)?r:r.$top,el:t,key:o}),r.componentsMap.set(o,n),n.render())}exports.render=render,exports.renderComponent=renderComponent,exports.renderLoop=renderLoop,exports.renderTextNode=renderTextNode,exports.renderElementNode=renderElementNode,exports.renderTemplateNode=renderTemplateNode,exports.renderSlotNode=renderSlotNode,exports.renderDynamicComponentNode=renderDynamicComponentNode,exports.renderComponentNode=renderComponentNode;
//# sourceMappingURL=render.js.map
