"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var r,t=1,o=arguments.length;t<o;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e}).apply(this,arguments)};Object.defineProperty(exports,"__esModule",{value:!0}),exports.isProxyProperty=exports.getPropertyVisitPathStr=exports.createPropsProxy=exports.createComponentProxy=exports.createVueProxy=exports.createContext=void 0;var util_1=require("./util"),dirtyStack_1=require("../compiler/dirtyStack"),util_2=require("../shared/util"),render_1=require("../compiler/render"),constants_1=require("../shared/constants");function createContext(e,r){void 0===r&&(r={});var t,o=__assign({},r||{});for(t in e)isProxyProperty(t)&&(o[t]=e[t]);return o}function createProxy(srcObj,renderHandler){var self=this,proxy=null,p;if(!util_2.isObject(srcObj)&&!util_2.isArray(srcObj))return proxy;for(p in proxy=new Proxy(srcObj,{get:function(e,r,t){return r in(self.$config.computed||{})&&(null!==e[r]&&void 0!==e[r]||(e[r]=self.$config.computed[r].call(self.$dataProxy))),Reflect.get(e,r,t)},set:function(target,key,value,receiver){if(!isProxyProperty(key)||util_1.isComputedProperty(target,key))return Reflect.set(target,key,value,receiver);var propertyAccessStr=getPropertyVisitPathStr(target,key),cloneValue,handler_1,newVal_1,array;self.$config.watch&&util_2.isObject(self.$config.watch)&&(handler_1=self.$config.watch[propertyAccessStr],handler_1&&(cloneValue=util_2.cloneDeep(value),newVal_1=cloneValue,util_2.isArray(target)&&"length"!==key&&(array=util_2.cloneDeep(eval("self.$noProxySrcData."+propertyAccessStr)),array[key]=cloneValue,newVal_1=array),util_2.createExecutionContext.call(self,self,function(){handler_1.call(self,util_2.execExpression(self.$noProxySrcData,propertyAccessStr),newVal_1)})));var cloneDeepRef=util_2.cloneDeep;eval("if(!cloneValue) {cloneValue = cloneDeepRef(value);}"),util_2.isArray(target)&&"length"!==key?eval("self.$noProxySrcData."+propertyAccessStr+"["+key+"] = cloneValue"):eval("self.$noProxySrcData."+propertyAccessStr+" = cloneValue"),(util_2.isObject(value)||util_2.isArray(value))&&(value=createProxy.call(self,value,renderHandler),value[constants_1.PATH_SYMBOLS[0]]=key,value[constants_1.PATH_SYMBOLS[1]]=target);var result=Reflect.set(target,key,value,receiver);return dirtyStack_1.push(renderHandler,value),result},deleteProperty:function(target,property){if(!isProxyProperty(property)||util_1.isComputedProperty(target,property))return Reflect.deleteProperty(target,property);var propertyAccessStr=getPropertyVisitPathStr(target,property),handler_2;self.$config.watch&&util_2.isObject(self.$config.watch)&&(handler_2=self.$config.watch[propertyAccessStr],handler_2&&util_2.createExecutionContext.call(self,self,function(){handler_2.call(self,util_2.execExpression(self.$noProxySrcData,propertyAccessStr),null)})),eval("delete self.$noProxySrcData."+propertyAccessStr);var result=Reflect.deleteProperty(target,property);return dirtyStack_1.push(renderHandler,property),result}}),srcObj){var objItem=srcObj[p];isProxyProperty(p)&&(util_2.isObject(objItem)||util_2.isArray(objItem))&&(srcObj[p]=createProxy.call(self,objItem,renderHandler),objItem[constants_1.PATH_SYMBOLS[0]]=util_2.isArray(srcObj)?"["+p+"]":p,objItem[constants_1.PATH_SYMBOLS[1]]=srcObj)}return proxy}function createVueProxy(e){return createProxy.call(this,e,function(){render_1.render.call(this,this.$config.el,!1)})}function createComponentProxy(e){return createProxy.call(this,e,function(){var e=render_1.renderComponent.call(this);e.key=this.$key,this.assignClassAndStyle(e),this.$top&&util_2.isFunction(this.$top.refresh)&&this.$top.refresh(e)})}function createPropsProxy(props){var self=this;return new Proxy(props,{set:function(target,key,value,receiver){var handler_3,cloneValue,newVal_2,array;return self.$config.watch&&util_2.isObject(self.$config.watch)&&(handler_3=self.$config.watch[key],handler_3&&(cloneValue=util_2.cloneDeep(value),newVal_2=cloneValue,util_2.isArray(target)&&"length"!==key&&(array=util_2.cloneDeep(eval("self.$noProxySrcData."+key)),array[key]=cloneValue,newVal_2=array),util_2.createExecutionContext.call(self,self,function(){handler_3.call(self,util_2.execExpression(self.$noProxySrcData,key),newVal_2)}))),Reflect.set(target,key,value,receiver)}})}function getPropertyVisitPathStr(e,r){var t=util_2.isArray(e)&&"length"!==r?[]:[r];e[constants_1.PATH_SYMBOLS[0]]&&t.push(e[constants_1.PATH_SYMBOLS[0]]);for(var o=e[constants_1.PATH_SYMBOLS[1]];o;)o[constants_1.PATH_SYMBOLS[0]]&&t.push(o[constants_1.PATH_SYMBOLS[0]]),o=o[constants_1.PATH_SYMBOLS[1]];t.reverse();for(var a=[],n=0;n<t.length;n++){var l=t[n];l.startsWith("[")&&l.endsWith("]")?a[a.length-1]=""+a[a.length-1]+l:a.push(l)}return a.join(".")}function isProxyProperty(r){return!(constants_1.CREATE_PROXY_EXCLUDE_PREFIX.some(function(e){return r.startsWith(e)})||constants_1.CREATE_PROXY_EXCLUDE_SUFFIX.some(function(e){return r.endsWith(e)}))}exports.createContext=createContext,exports.createVueProxy=createVueProxy,exports.createComponentProxy=createComponentProxy,exports.createPropsProxy=createPropsProxy,exports.getPropertyVisitPathStr=getPropertyVisitPathStr,exports.isProxyProperty=isProxyProperty;
//# sourceMappingURL=proxy.js.map
